<!DOCTYPE html>
<html>
<head>
<script src="jquery-3.5.0.min.js" type="text/javascript"></script>
<link href="style.css" rel="stylesheet" type="text/css">
</head>
<body>
  <table id="table">
    <tr>
      <th>
        <select id="items" onchange="displayStats()">
          <option disabled selected>-- Select an item --</option>
        </select>
      </th>
      <th>HP</th>
      <th>TP</th>
      <th>AP</th>
      <th>ATK</th>
      <th>DEF</th>
      <th>MAG</th>
      <th>SPR</th>
      <th>ACC</th>
      <th>DEX</th>
      <th>AGI</th>
      <th>EVA</th>
      <th>CRIT</th>
      <th>CRIT.A</th>
    </tr>
    <span id="grow1"></span>
    <span id="grow2"></span>
    <span id="grow3"></span>
  </table>

  <script>
    let stats = [{
      label: "HP",
      value: "hp"
    }, {
      label: "TP",
      value: "mp"
    }, {
      label: "AP",
      value: "ap"
    }, {
      label: "ATK",
      value: "atk"
    }, {
      label: "DEF",
      value: "def"
    }, {
      label: "MAG",
      value: "mag"
    }, {
      label: "SPR",
      value: "mnd"
    }, {
      label: "ACC",
      value: "hit"
    }, {
      label: "DEX",
      value: "dex"
    }, {
      label: "AGI",
      value: "spd"
    }, {
      label: "EVA",
      value: "avd"
    }, {
      label: "CRIT",
      value: "crt"
    }, {
      label: "CRIT.A",
      value: "crta"
    }]
    function displayStats() {
      let itemKey = $('#items').val();

      $('#grow1').empty();
      $('#grow2').empty();
      $('#grow3').empty();

      let item = itemMap[itemKey];
      let types = typeMap[item.rtype];
      types.forEach((type, i) => {
        let typeGrowth = growthMap[type.value];
        let typeRow = $('#grow' + (i+1));
        let item_stats = getItemStat(typeGrowth.curve[0], item.status[1]);

        let typeInnerHtml = '';
        typeInnerHtml += '<tr><td>' + type.label + '</td>';

        stats.forEach((stat) => {
          let text = '';
          if (item_stats[stat.value]) {
            text = item.status[0][stat.value] + '/' + item_stats[stat.value];
          }

          typeInnerHtml += '<td>' + text + '</td>';
        });

        typeInnerHtml += '</tr>';
        typeRow.append(typeInnerHtml);
      });
    }

    function getItemStat(curve, base) {
      let item_stats = {};

      stats.forEach((stat) => {
        if (base[stat.value]) {
          if (curve[stat.value]) {
            item_stats[stat.value] = Math.floor((100 + curve[stat.value]) / 100 * base[stat.value]);
          } else {
            item_stats[stat.value] = base[stat.value];
          }
        }
      });

      return item_stats;
    }

    let growthMap = {}, nameMap = {}, typeMap = {};
    let itemMap = {};

    $.getJSON('typenames.json', function(data) {
      let typeNameMap = {};
      data.infos.forEach((info) => {
        typeNameMap[info.key] = info.value;
      });
      $.getJSON('typesets.json', function(data) {
        data.items.forEach((item) => {
          typeMap[item.iname] = [
            {
              label: typeNameMap[item.lot[0].grow1],
              value: item.lot[0].grow1
            }, {
              label: typeNameMap[item.lot[0].grow2],
              value: item.lot[0].grow2
            }, {
              label: typeNameMap[item.lot[0].grow3],
              value: item.lot[0].grow3
            }
          ];
        });
      });
    });

    $.getJSON('growth.json', function(data) {
      data.items.forEach((item) => {
        growthMap[item.type] = {
          curve: item.curve,
          rstatus : item.rstatus
        }
      });
    });

    $.getJSON('names.json', function(data) {
      data.infos.forEach((info) => {
        nameMap[info.key] = info.value;
      });

      $.getJSON('items.json', function(data) {
        data.items.forEach((item) => {
          if (item.type >= 0) {
            $('#items').append('<option value="' + item.iname +'">' + nameMap[item.iname] + '</option>');

            itemMap[item.iname] = {
              name: nameMap[item.iname],
              rtype: item.rtype,
              status: item.status,
              type: item.type
            };
          }
        });
      });
    });
  </script>
</body>
</html>
