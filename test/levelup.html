<!DOCTYPE html>
<html>
<head>
<script src="jquery-3.5.0.min.js" type="text/javascript"></script>
<link href="base.css" rel="stylesheet" type="text/css">
<link id="theme" href="dark.css" rel="stylesheet" type="text/css">
<script>
  if (window.localStorage.getItem('light')) {
    $('head #theme').attr('href', 'light.css');
  }
  function toggleCSS() {
    if (window.localStorage.getItem('light')) {
      window.localStorage.removeItem('light');
      $('head #theme').attr('href', 'dark.css');
    } else {
      window.localStorage.setItem('light', true);
      $('head #theme').attr('href', 'light.css');
    }
  }
</script>
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-164908860-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-164908860-1');
</script>
<title>WotV:FFBE Equipment Calculator</title>
</head>
<body>
  <div id="header">
    Equipment Calculator
    <div id="css_toggle" onclick="toggleCSS()">
      <img id="light" src="img/items/IT_UN_AW_SHINE.png" title="Turn off Dark Mode"/>
      <img id="dark" src="img/items/IT_UN_AW_DARK.png" title="Turn on Dark Mode"/>
    </div>
    <div id="support_link">
      <a target="_blank" href="https://www.buymeacoffee.com/sairenkao">
        <img src="img/items/IT_LP_WW_01.png" title="Buy me visiore"/>
        <span>Buy me visiore</span>
      </a>
    </div>
  </div>

  <div id="main_content">
    <div id="inputs">
      <select id="category" onchange="onCategoryChange()">
        <option disabled selected>-- Select an category --</option>
      </select>
      <select id="artifacts" class="hidden" onchange="onArtifactChange()">
        <optgroup id="artifacts-weapon" label="Weapon"></optgroup>
        <optgroup id="artifacts-armor" label="Armor"></optgroup>
        <optgroup id="artifacts-accessory" label="Accessory"></optgroup>
      </select>
      <select id="types" class="hidden" onchange="onTypeChange()">
      </select>
    </div>
    <div id="start_tip" class="tips" onclick="dismiss(this)">
      <div class="speech_bubble">
        Welcome! Update this help text later. If you wish to work with my brother, click on the Awakening Prism at the top at anytime.
      </div>
    </div>

    <div id="content" class="hidden">
      <div class="grid">
        <div class="cell" id="info">
          <div class="cell_content">
            <div id="item_image" class="equipment">
              <img src=""/>
            </div>
          </div>
        </div>

        <div class="cell" id="growth">
          <div class="cell_content">
            <table id="stats">
              <tr>
                <th>Level</th>
                <th>HP</th>
                <th>TP</th>
                <th>AP</th>
                <th>ATK</th>
                <th>DEF</th>
                <th>MAG</th>
                <th>SPR</th>
                <th>ACC</th>
                <th>DEX</th>
                <th>AGI</th>
                <th>EVADE</th>
                <th>CRIT</th>
                <th>CRIT<br/>EVADE</th>
              </tr>
              <tr id="cur_stats"></tr>
            </table>
            <div id="next_step"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <footer>
    <a href="https://www.reddit.com/r/wotv_ffbe/comments/gd685f/lets_congregate_some_resources/">Other WotV Resources</a> |
    <a target="_blank" href="changelogs.html">Change Logs (Last updated 2020-06-10)</a> |
    <a target="_blank" href="https://github.com/wotv-tools/wotv-tools.github.io/issues/new">Report Issues</a> |
    <a target="_blank" href="https://github.com/shalzuth/wotv-ffbe-dump">Data source</a> |
    <a target="_blank" href="legal.html">Legal</a>
  </footer>

  <script>
    let stats = [{
      label: "HP",
      value: "hp"
    }, {
      label: "TP",
      value: "mp"
    }, {
      label: "AP",
      value: "ap"
    }, {
      label: "ATK",
      value: "atk"
    }, {
      label: "DEF",
      value: "def"
    }, {
      label: "MAG",
      value: "mag"
    }, {
      label: "SPR",
      value: "mnd"
    }, {
      label: "ACC",
      value: "hit"
    }, {
      label: "DEX",
      value: "dex"
    }, {
      label: "AGI",
      value: "spd"
    }, {
      label: "EVA",
      value: "avd"
    }, {
      label: "CRIT",
      value: "crt"
    }, {
      label: "CRIT EVADE",
      value: "crta"
    }];

    function dismiss(el) {
      $(el).addClass('dismissed');
    }

    function onCategoryChange() {
      let category = $('#category').val();

      $('#artifacts').empty();
      artifactListByCat[category].forEach((artifact) => {
        $('#artifacts').append('<option value="' + artifact.value + '">' + artifact.label + '</option>');
      });

      $('#artifacts').removeClass('hidden');
      $('#types').removeClass('hidden');
      $('#artifacts').change();
    }
    function onArtifactChange() {
      setItemInfo();
      $('#types').change();
    }
    function onTypeChange() {
      $('#start_tip').addClass('dismissed');
      displayStats();
    }

    function setItemInfo() {
      let itemKey = $('#artifacts').val();
      if (!itemKey) {
        return;
      }

      let item = artifactMap[itemKey];
      $('#item_image img').attr('src', 'img/equipment/' + item.asset + '.png');
      $('#item_image').removeClass().addClass('equipment');
      if (item.cat[0] > 0 && item.cat[0] < 17) {
        $('#item_image').addClass('weapon');
      } else if (item.cat[0] < 22) {
        $('#item_image').addClass('armor');
      } else if (item.cat[0] == 22) {
        $('#item_image').addClass('accessory');
      }
      $('#content').removeClass('hidden');

      $('#types').empty();
      let types = typeMap[item.rtype];
      types.forEach((type, i) => {
        $('#types').append('<option value="' + type.value + '">' + type.label + '</option>');
      });
    }

    let max_level = 50;
    function displayStats() {
      let itemKey = $('#artifacts').val();
      let type = $('#types').val();
      if (!itemKey || !type) {
        return;
      }

      $('#cur_stats').empty();
      let levelCell = $('<td></td>')
      let levelSelect = $('<select id="levels" onchange="calcNextLevel()"></select>');
      for (let i = 1; i <= max_level; i++) {
        levelSelect.append('<option value="' + i + '">' + i + '</option>');
      }
      levelCell.append(levelSelect);
      levelCell.append('<br/>' + max_level);
      $('#cur_stats').append(levelCell);

      let item = artifactMap[itemKey];
      stats.forEach((stat) => {
        let statCell = $('<td></td>');
        if (!isNaN(item.status[1][stat.value])) {
          let statSelect = $('<select class="stat stat_' + stat.value + '" onchange="calcNextLevel()"></select>');
          for (let i = item.status[0][stat.value]; i <= item.status[1][stat.value]; i++) {
            statSelect.append('<option value="' + i + '">' + i + '</option>');
          }
          statCell.append(statSelect);
          statCell.append('<br/>' + item.status[1][stat.value]);
        } else {
          statCell.text('-');
        }
        $('#cur_stats').append(statCell);
      });

      calcNextLevel();
    }

    function calcNextLevel() {
      let itemKey = $('#artifacts').val();
      let type = $('#types').val();
      if (!itemKey || !type) {
        return;
      }

      let item = artifactMap[itemKey];

      let level = $('#levels').val();
      let levels_left = max_level - level;
      let tar_level = level;

      let non_hp_stats_left = 0;
      let hp_stats_left = 0;
      stats.forEach((stat) => {
        let stat_left = item.status[1][stat.value] - $('.stat.stat_' + stat.value).val();
        if (stat.value == 'hp') {
          hp_stats_left += stat_left;
        } else {
          non_hp_stats_left += stat_left;
        }
      });

      let hp_from_hammers = 150;
      if (hp_stats_left <= hp_from_hammers) {
        if (non_hp_stats_left < levels_left) {
          tar_level = max_level - non_hp_stats_left;
          $('#next_step').text('Level this item up until level ' + tar_level + ' and update your stats.');
        } else if (non_hp_stats_left == levels_left) {
          $('#next_step').text('Max out the HP stat using HP hammers and update your stats.');
        } else {
          $('#next_step').text('No special instructions. Just level this item up normally.');
        }
      } else if (hp_stats_left == 0) {
        if (non_hp_stats_left <= levels_left) {
          $('#next_step').text('Level this item up until level ' + max_level + '.');
        }
      } else {
        $('#next_step').text('Level this item up until the HP stat is at least ' + (item.status[1]['hp'] - hp_from_hammers) + ' and update your stats.');
      }
    }

    let promiseList = [];

    let typeMap = {};
    promiseList.push(new Promise((resolve, reject) => {
      // init
      $.getJSON('en/ArtifactGrow.json', (data) => {
        let typeNameMap = {};
        data.infos.forEach((info) => {
          typeNameMap[info.key] = info.value;
        });
        // 20200422_4c9ea1e3
        $.getJSON('data/ArtifactRandLot.json', (data) => {
          data.items.forEach((item) => {
            typeMap[item.iname] = [];
            if (item.lot[0].grow1) {
              typeMap[item.iname].push({
                label: typeNameMap[item.lot[0].grow1],
                value: item.lot[0].grow1
              });
            }
            if (item.lot[0].grow2) {
              typeMap[item.iname].push({
                label: typeNameMap[item.lot[0].grow2],
                value: item.lot[0].grow2
              });
            }
            if (item.lot[0].grow3) {
              typeMap[item.iname].push({
                label: typeNameMap[item.lot[0].grow3],
                value: item.lot[0].grow3
              });
            }
          });

          resolve();
        });
      });
    }));

    let growthMap = {};
    promiseList.push(new Promise((resolve, reject) => {
      // init
      $.getJSON('data/Grow.json', (data) => {
        data.items.forEach((item) => {
          growthMap[item.type] = {
            curve: item.curve,
            rstatus : item.rstatus
          }
        });

        resolve();
      });
    }));

    let artifactNameMap = {};
    promiseList.push(new Promise((resolve, reject) => {
      // 20200422_4c9ea1e3 translations
      $.getJSON('en/ArtifactName.json', (data) => {
        data.infos.forEach((info) => {
          artifactNameMap[info.key] = info.value;
        });

        resolve();
      });
    }));

    let artifactCategoryList = [];
    promiseList.push(new Promise((resolve, reject) => {
      // init
      $.getJSON('en/ArtifactCategory.json', (data) => {
        artifactCategoryList = data.infos;

        // for some reason doesn't match exactly
        artifactCategoryList.splice(4,1); // remove LARGESWORD
        artifactCategoryList.splice(6,1); // remove ROD
        artifactCategoryList.splice(18,2); // LIGHTSHIELD, HEAVYSHIELD
        artifactCategoryList.splice(22,3); // LIGHTARMOR, HEAVYARMOR, ROBE

        artifactCategoryList.forEach((cat, i) => {
          switch(cat.key) {
            case 'NONE':
            case 'HAMMER':
            case 'INSTRUMENT':
            case 'WHIP':
            case 'THROWING':
            case 'SEPARATOR':
              break;
            default:
              $('#category').append('<option value="' + i + '">' + cat.value + '</option>');
              break;
          }
        });

        resolve();
      });
    }));

    let artifactMap = {};
    let artifactListByCat = [];
    promiseList.push(new Promise((resolve, reject) => {
      $.getJSON('data/Artifact.json', (data) => {
        data.items.forEach((item) => {
          if (item.type >= 0 && item.rtype != 'AF_LOT_50' && item.rtype != 'AF_LOT_TRUST') {
            artifactMap[item.iname] = item;
            artifactMap[item.iname].name = artifactNameMap[item.iname];

            if (artifactNameMap[item.iname]) {
              let artifactListEntry = {
                label: artifactNameMap[item.iname],
                value : item.iname
              };

              item.cat.forEach((cat) => {
                if (artifactListByCat[cat] == null) {
                  artifactListByCat[cat] = [];
                }

                artifactListByCat[cat].push(artifactListEntry);
              });
            }
          }
        });

        artifactListByCat.forEach((artifactList) => {
          artifactList.sort((a, b) => {
            return a.label > b.label ? 1 : -1;
          });
        });

        $('#category').focus();
        resolve();
      });
    }));

    Promise.all(promiseList).then(() => {

    });
  </script>
</body>
</html>
