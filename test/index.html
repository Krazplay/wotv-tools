<!DOCTYPE html>
<html>
<head>
<script src="jquery-3.5.0.min.js" type="text/javascript"></script>
<link href="base.css" rel="stylesheet" type="text/css">
<link id="theme" href="dark.css" rel="stylesheet" type="text/css">
<script>
  if (window.localStorage.getItem('light')) {
    $('head #theme').attr('href', 'light.css');
  }
  function toggleCSS() {
    if (window.localStorage.getItem('light')) {
      window.localStorage.removeItem('light');
      $('head #theme').attr('href', 'dark.css');
    } else {
      window.localStorage.setItem('light', true);
      $('head #theme').attr('href', 'light.css');
    }
  }
</script>
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-164908860-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-164908860-1');
</script>
<title>WotV:FFBE Equipment Calculator</title>
</head>
<body>
  <div id="header">
    Equipment Calculator
    <div id="css_toggle" onclick="toggleCSS()">
      <img id="light" src="img/items/IT_UN_AW_SHINE.png" title="Turn off Dark Mode"/>
      <img id="dark" src="img/items/IT_UN_AW_DARK.png" title="Turn on Dark Mode"/>
    </div>
    <div id="support_link">
      <a target="_blank" href="https://www.buymeacoffee.com/sairenkao">
        <img src="img/items/IT_LP_WW_01.png" title="Buy me visiore"/>
        <span>Buy me visiore</span>
      </a>
    </div>
  </div>

  <div id="main_content">
    <div id="inputs">
      <select id="category" onchange="onCategoryChange()">
        <option disabled selected>-- Select an category --</option>
      </select>
      <select id="artifacts" class="hidden" onchange="onArtifactChange()">
        <optgroup id="artifacts-weapon" label="Weapon"></optgroup>
        <optgroup id="artifacts-armor" label="Armor"></optgroup>
        <optgroup id="artifacts-accessory" label="Accessory"></optgroup>
      </select>
      <select id="level" class="hidden" onchange="onLevelChange()"></select>
    </div>
    <div id="start_tip" class="tips">
      <div class="speech_bubble">Welcome! This tool calculates the average stat gain for equipment. To get started, choose an equipment from the inputs above! If you wish to learn from my brother, click on the Awakening Prism at the top at anytime.</div>
    </div>

    <div id="content" class="hidden">
      <div class="grid">
        <div class="cell" id="info">
          <div class="cell_content">
            <div id="item_image" class="equipment">
              <img src=""/>
            </div>
            <table>
              <tr>
                <td><b>Rarity</b></td>
                <td id="rarity"></td>
              </tr>
              <tr>
                <td><b>Type</b></td>
                <td id="type"></td>
              </tr>
              <tr>
                <td id="skills" colspan="2"></td>
              </tr>
            </table>
          </div>
        </div>

        <div class="cell" id="growth">
          <div class="cell_content">
            <table id="stats">
              <tr>
                <th colspan="14">Average Stat Growth</th>
              </tr>
              <tr>
                <th>Growth<br/>Type</th>
                <th>HP</th>
                <th>TP</th>
                <th>AP</th>
                <th>ATK</th>
                <th>DEF</th>
                <th>MAG</th>
                <th>SPR</th>
                <th>ACC</th>
                <th>DEX</th>
                <th>AGI</th>
                <th>EVADE</th>
                <th>CRIT</th>
                <th>CRIT<br/>EVADE</th>
              </tr>
              <tr id="grow1_stats" class="selectable" onclick="save(this)"></tr>
              <tr id="grow2_stats" class="selectable" onclick="save(this)"></tr>
              <tr id="grow3_stats" class="selectable" onclick="save(this)"></tr>
              <tr id="grow_div" class="hidden"></tr>
              <tr id="grow_amt" class="hidden"></tr>
              <tr id="seals" class="hidden">
                <th>Seals</th>
                <td class="stat stat_0" onclick="toggleSeal(0)">
                  <label for=""><img src="img/items/IT_AF_SUP_HP.png"/></label>
                  <input type="checkbox" class="hidden" disabled />
                </td>
                <td></td>
                <td></td>
                <td class="stat stat_3" onclick="toggleSeal(3)">
                  <label for=""><img src="img/items/IT_AF_SUP_ATK.png"/></label>
                  <input type="checkbox" class="hidden" disabled />
                </td>
                <td class="stat stat_4" onclick="toggleSeal(4)">
                  <label for=""><img src="img/items/IT_AF_SUP_DEF.png"/></label>
                  <input type="checkbox" class="hidden" disabled />
                </td>
                <td class="stat stat_5" onclick="toggleSeal(5)">
                  <label for=""><img src="img/items/IT_AF_SUP_MAG.png"/></label>
                  <input type="checkbox" class="hidden" disabled />
                </td>
                <td class="stat stat_6" onclick="toggleSeal(6)">
                  <label for=""><img src="img/items/IT_AF_SUP_MND.png"/></label>
                  <input type="checkbox" class="hidden" disabled />
                </td>
                <td class="stat stat_7" onclick="toggleSeal(7)">
                  <label for=""><img src="img/items/IT_AF_SUP_HIT.png"/></label>
                  <input type="checkbox" class="hidden" disabled />
                </td>
                <td></td>
                <td></td>
                <td class="stat stat_10" onclick="toggleSeal(10)">
                  <label for=""><img src="img/items/IT_AF_SUP_AVO.png"/></label>
                  <input type="checkbox" class="hidden" disabled />
                </td>
                <td class="stat stat_11" onclick="toggleSeal(11)">
                  <label for=""><img src="img/items/IT_AF_SUP_CRI.png"/></label>
                  <input type="checkbox" class="hidden" disabled />
                </td>
                <td></td>
              </tr>
            </table>
          </div>
          <div id="seals_tip" class="tips hidden">
            <div class="speech_bubble">Click on the seals above to see how the average changes with seals! Seals are applied every level until the stat is maxed.</div>
          </div>
          <div id="save_tip" class="tips hidden">
            <div class="speech_bubble">If you like what you see, you can click on the entry to save it down below!</div>
          </div>
        </div>
      </div>

      <div id="materials" class="grid hidden">
        <div class="cell">
          <div class="cell_content">
            <table id="recipe_mats"></table>
          </div>
        </div>
        <div class="cell">
          <div class="cell_content">
            <table id="awake_mats"></table>
          </div>
        </div>
        <div class="cell">
          <div class="cell_content">
            <table id="total_mats"></table>
          </div>
        </div>
      </div>
    </div>

    <div id="saved" class="grid hidden">
      <div class="cell">
        <div class="cell_content">
          <textarea class="hidden" id="copy_txt"></textarea>
          <table>
            <tr>
              <th colspan="15">Saved Equipment</th>
            <tr>
              <th>Equipment</th>
              <th></th>
              <th>HP</th>
              <th>TP</th>
              <th>AP</th>
              <th>ATK</th>
              <th>DEF</th>
              <th>MAG</th>
              <th>SPR</th>
              <th>ACC</th>
              <th>DEX</th>
              <th>AGI</th>
              <th>EVADE</th>
              <th>CRIT</th>
              <th>CRIT<br/>EVADE</th>
            </tr>
          </table>
        </div>
        <div class="tips hidden">
          <div class="speech_bubble">You can remove any unwanted entries by clicking on them! Once you are ready, you can share the link above.</div>
        </div>
      </div>
    </div>
  </div>

  <footer>
    <a href="https://www.reddit.com/r/wotv_ffbe/comments/gd685f/lets_congregate_some_resources/">Other WotV Resources</a> |
    <a target="_blank" href="changelogs.html">Change Logs (Last updated 2020-06-17)</a> |
    <a target="_blank" href="https://github.com/wotv-tools/wotv-tools.github.io/issues/new">Report Issues</a> |
    <a target="_blank" href="https://github.com/shalzuth/wotv-ffbe-dump">Data source</a> |
    <a target="_blank" href="legal.html">Legal</a>
  </footer>

  <script>
    let mat_link = 'https://wotvfarmcalculator.github.io/?i=';
    let stats = [{
      label: "HP",
      value: "hp"
    }, {
      label: "TP",
      value: "mp"
    }, {
      label: "AP",
      value: "ap"
    }, {
      label: "ATK",
      value: "atk"
    }, {
      label: "DEF",
      value: "def"
    }, {
      label: "MAG",
      value: "mag"
    }, {
      label: "SPR",
      value: "mnd"
    }, {
      label: "ACC",
      value: "hit"
    }, {
      label: "DEX",
      value: "dex"
    }, {
      label: "AGI",
      value: "spd"
    }, {
      label: "EVA",
      value: "avd"
    }, {
      label: "CRIT",
      value: "crt"
    }, {
      label: "CRIT EVADE",
      value: "crta"
    }];

    function onCategoryChange() {
      let category = $('#category').val();

      $('#artifacts').empty();
      artifactListByCat[category].forEach((artifact) => {
        $('#artifacts').append('<option value="' + artifact.value + '">' + artifact.label + '</option>');
      });

      $('#artifacts').removeClass('hidden');
      $('#artifacts').change();
    }
    function onArtifactChange() {
      $('#start_tip').addClass('dismissed');
      resetSeals();
      setItemInfo();
    }
    function onLevelChange() {
      displayStats();
    }

    function displayStats() {
      let itemKey = $('#artifacts').val();
      if (!itemKey) {
        return;
      }

      let item = artifactMap[itemKey];
      let level = parseInt($('#level').val());
      let item_sk = item['skl' + Math.ceil(level/10)];

      $('#item_image img').attr('src', 'img/equipment/' + item.asset + '.png');

      $('#type').empty();
      item.cat.forEach((cat) => {
        $('#type').append('<div>' + artifactCategoryList[cat].value + '</div>');
      });

      $('#rarity').empty();
      switch (item.rare) {
        case 0:
          $('#rarity').append('<div>N</div>');
          break;
        case 1:
          $('#rarity').append('<div>R</div>');
          break;
        case 2:
          $('#rarity').append('<div>SR</div>');
          break;
        case 3:
          $('#rarity').append('<div>MR</div>');
          break;
        case 4:
          $('#rarity').append('<div>UR</div>');
          break;
      }

      $('#skills').empty();
      if (item_sk) {
        item_sk.forEach((skl) => {
          let skill = skillMap[skl];
          if (skill.grow == 'SKILL_DEFAULT' && skillNameMap[skl]) {
              $('#skills').append('<div class="skill_desc">' + skillNameMap[skl] + '</div>');
          } else {
            if (skill.s_buffs) {
              skill.s_buffs.forEach((s_buff) => {
                $('#skills').append(getBuffNames(s_buff, skill.grow, level));
              });
            }
            if (skill.t_buffs) {
              skill.t_buffs.forEach((t_buff) => {
                $('#skills').append(getBuffNames(t_buff, skill.grow, level));
              });
            }
          }
        });
      }

      if (!$.trim($('#skills').html())) {
          $('#skills').append('<div>-</div>');
      }

      // $('#desc').empty();
      // $('#desc').append(artifactFlavorMap[item.iname]);

      $('#grow1_stats').empty();
      $('#grow2_stats').empty();
      $('#grow3_stats').empty();
      let types = typeMap[item.rtype];

      types.forEach((type, i) => {
        let typeGrowth = growthMap[type.value];
        let typeStatsRow = $('#grow' + (i+1) + '_stats');
        let artifact_stats, artifact_rates, ave_stats;

        switch (type.value) {
          case 'ARTIFACT_TRUST':
            artifact_stats = item.status[1];
            ave_stats = item.status[1];
            break;
          case 'ARTIFACT_50':
            artifact_stats = item.status[1];
            ave_stats = Object.assign({}, item.status[0]);

            stats.forEach((stat) => {
              if (!isNaN(artifact_stats[stat.value])) {
                // guessing growth for no rstatus growth
                ave_stats[stat.value] = item.status[0][stat.value] + (item.status[1][stat.value] - item.status[0][stat.value]) * Math.min(level-1, typeGrowth.curve[0].lv-1) / (typeGrowth.curve[0].lv-1);
              }
            });

            break;
          default:
            artifact_stats = getArtifactStats(typeGrowth.curve[0], item.status[1]);
            artifact_rates = getArtifactRates(typeGrowth.rstatus[0], item.randr[0]);
            ave_stats = Object.assign({}, item.status[0]);

            for (let i = 1; i < level; i++) {
              let pity_rate = 1;
              let pity_stat;

              stats.forEach((stat) => {
                if (!isNaN(artifact_stats[stat.value])) {
                  ave_stats[stat.value] += item.randa[0][stat.value] * artifact_rates[stat.value] / 100;
                  pity_rate *= (1 - (artifact_rates[stat.value] / 100));

                  if (!pity_stat || artifact_rates[stat.value] > artifact_rates[pity_stat]) {
                      pity_stat = stat.value;
                  }

                  if (ave_stats[stat.value] > artifact_stats[stat.value]) {
                    ave_stats[stat.value] = artifact_stats[stat.value];
                    artifact_rates[stat.value] = 0;
                  }
                }
              });

              // add pity
              ave_stats[pity_stat] += pity_rate;
              if (ave_stats[pity_stat] > artifact_stats[pity_stat]) {
                ave_stats[pity_stat] = artifact_stats[pity_stat];
                artifact_rates[pity_stat] = 0;
              }
            }

            // reset. get base artifact rates
            artifact_rates = getArtifactRates(typeGrowth.rstatus[0], item.randr[0]);

            break;
        }

        typeStatsRow.append('<td><b>' + (type.label ? type.label : '-') + '</b></td>');
        stats.forEach((stat, i) => {
          if (ave_stats[stat.value] > artifact_stats[stat.value]) {
            ave_stats[stat.value] = artifact_stats[stat.value];
            artifact_rates[stat.value] = 0;
          } else {
            ave_stats[stat.value] = Math.round(ave_stats[stat.value]);
          }

          if (!isNaN(artifact_stats[stat.value] && item.status[0][stat.value] != 0 && artifact_stats[stat.value] != 0)) {
            $('.stat.stat_' + stat.value + ' img').removeClass('hidden');
            let tdEl = '';
            if (seals[i]) {
              tdEl = '<td><b>' + ave_stats[stat.value] + '</b> / ' + artifact_stats[stat.value];
              if (artifact_rates) {
                tdEl += '<br/><span><b>' + artifact_rates[stat.value] + '%</b></span></td>';
              }
            } else {
              tdEl = '<td>' + ave_stats[stat.value] + ' / ' + artifact_stats[stat.value];
              if (artifact_rates) {
                tdEl += '<br/><span>' + artifact_rates[stat.value] + '%</span></td>';
              }
            }

            typeStatsRow.append(tdEl);
          } else {
            typeStatsRow.append('<td> - </td>');
          }
        });
      });

      // get recipe
      $('#materials').addClass('hidden');
      $('#materials table').empty();
      if (artifactRecipeMap[item.iname]) {
        $('#recipe_mats').append('<tr><th colspan="2">Recipe</th></tr>');
        $('#awake_mats').append('<tr><th colspan="2">Awakening</th></tr>');
        $('#total_mats').append('<tr><th colspan="2">Total Materials</th></tr>');
        let mats = getTotalMaterials(item.iname, level);

        for (let mat in mats.recipe) {
          let item = mats.recipe[mat].type ? artifactMap[mat] : itemMap[mat];
          let itemName = mats.recipe[mat].type ? artifactNameMap : itemNameMap[mat];
          let mat_url = mat_link + encodeURIComponent(itemName);
          let img_url = '/img/items/' + mat + '.png';
          let tr = $('<tr></tr>');
          let td = $('<td></td>');

          if (mats.recipe[mat].type) {
            img_url = 'img/equipment/' + item.asset + '.png';
            td.append('<div class="material recipe"><img src="' + img_url + '"/></div>');
          } else {
            img_url = 'img/items/' + mat + '.png';
            td.append('<div class="material"><img src="' + img_url + '"/></div>');
          }
          td.append('<div>' + mats.recipe[mat] + 'x</div>');
          tr.append(td);
          tr.append('<td><a target="_blank" href="' + mat_url + '">' + itemName + '</a></td>');
          $('#recipe_mats').append(tr);
        }

        for (let mat in mats.total) {
          let item = itemMap[mat];
          let itemName = itemNameMap[mat];
          let mat_url = mat_link + encodeURIComponent(itemName);
          let img_url = '/img/items/' + mat + '.png';
          let tr = $('<tr></tr>');
          let td = $('<td></td>');

          if (item.icon) {
            img_url = 'img/equipment/' + artifactMap[item.icon].asset + '.png';
            td.append('<div class="material recipe"><img src="' + img_url + '"/></div>');
          } else {
            img_url = 'img/items/' + mat + '.png';
            td.append('<div class="material"><img src="' + img_url + '"/></div>');
          }
          td.append('<div>' + mats.total[mat] + 'x</div>');
          tr.append(td);
          tr.append('<td><a target="_blank" href="' + mat_url + '">' + itemName + '</a></td>');
          $('#total_mats').append(tr);
        }

        $('#materials').removeClass('hidden');
      }

      $('#content').removeClass('hidden');
    }

    function getBuffNames(_buff, grow, level) {
      let buffNamesEl = '';
      let buff = buffMap[_buff];
      let buff_text, killer_index_offset;
      let growth = growthMap[grow];

      // NOT SURE WHY THESE ARE OFF
      switch (_buff) {
        // Katana > Lightning Katana
        case 'BUFF_KAT_LW_OOOO_1_1':
          buff.tag1[0] = 100;
          break;
        // Accessory > Magical String
        case 'BUFF_ACC_LW_THLA_1_1':
          buff.type1 = 120;
          break;
      }

      let buff_index = 1;
      while (buff['type' + buff_index] && buff_index <= 9) {
        let buff_value_min = buff['val' + buff_index];
        let buff_value_max = buff['val' + buff_index + '1'];
        let buff_value = Math.floor((level - 1) / (growth.curve[0].lv - 1) * (buff_value_max - buff_value_min) + buff_value_min);
        switch (buff['type' + buff_index]) {
          // Elemental Killer
          case 119:
            killer_index_offset = 83;
            buff_text = buffNameList[buff['type' + buff_index] + buff['tag' + buff_index][0] + killer_index_offset].value + ' ' + buff_value;
            break;
          // Species Killer
          case 120:
            killer_index_offset = 0;
            buff_text = buffNameList[buff['type' + buff_index] + buff['tag' + buff_index][0] + killer_index_offset].value + ' ' + buff_value;
            break;
          // Condition Granted
          case 123:
            let buff2 = buffMap[buff[['id' + buff_index]]];
            buff_text = buffNameList[buff2.type1].value + ' Granted (' + buff2.turn + ' turns, ' + buff2.rate + '%)';
            break;
          // Enchant
          case 134:
            buff_text = buffNameList[buff['type' + buff_index] + buff['tag' + buff_index][0]].value + ' ' + buff_value;
            break;
          default:
            buff_text = buffNameList[buff['type' + buff_index]].value;

            switch (buff['calc' + buff_index]) {
              case 3:
                buff_text += ' Res';
                break;
            }

            buff_text += ' ' + buff_value;
            break;
        }
        buffNamesEl += '<div class="skill_desc">' + buff_text + '</div>';
        buff_index++;
      }

      return buffNamesEl;
    }

    function setItemInfo() {
      let itemKey = $('#artifacts').val();
      if (!itemKey) {
        return;
      }

      let item = artifactMap[itemKey];
      let types = typeMap[item.rtype];

      $('#level').empty();
      $('#grow_div').addClass('hidden');
      $('#grow_amt').addClass('hidden');
      $('#seals').addClass('hidden');
      $('#seals_tip').addClass('hidden');

      $('#grow_amt').empty();
      switch (types[0].value) {
        case 'ARTIFACT_TRUST':
          $('#level').append('<option value="1">Lv. 1</option>');
          $('#level').val('1');
          $('#save_tip').removeClass('hidden');
          break;
        case 'ARTIFACT_50':
          $('#level').append('<option value="1">Lv. 1</option>');
          $('#level').append('<option value="10">Lv. 10</option>');
          $('#level').append('<option value="20">Lv. 20</option>');
          $('#level').append('<option value="30">Lv. 30</option>');
          $('#level').val('30');
          $('#save_tip').removeClass('hidden');
          break;
        default:
          $('#level').append('<option value="1">Lv. 1</option>');
          $('#level').append('<option value="10">Lv. 10</option>');
          $('#level').append('<option value="20">Lv. 20</option>');
          $('#level').append('<option value="30">Lv. 30</option>');
          $('#level').append('<option value="40">Lv. 40</option>');
          $('#level').append('<option value="50">Lv. 50</option>');
          $('#level').val('50');

          $('#grow_amt').append('<th>Growth</th>');
          stats.forEach((stat, i) => {
            if (item.randa[0][stat.value]) {
              $('#grow_amt').append('<td>+' + item.randa[0][stat.value] + '</td>');
              $('#seals .stat_' + i + ' img').removeClass('hidden');
            } else {
              $('#grow_amt').append('<td>-</td>');
            }
          });

          $('#grow_amt').removeClass('hidden');
          $('#seals_tip').removeClass('hidden');
          $('#save_tip').addClass('hidden');
          $('#grow_div').removeClass('hidden');
          $('#seals').removeClass('hidden');
          break;
      }
      $('#level').removeClass('hidden');
      $('#level').change();

      $('#item_image').removeClass().addClass('equipment');
      if (item.cat[0] > 0 && item.cat[0] < 17) {
        $('#item_image').addClass('weapon');
      } else if (item.cat[0] < 22) {
        $('#item_image').addClass('armor');
      } else if (item.cat[0] == 22) {
        $('#item_image').addClass('accessory');
      }
    }

    let seals = {}
    function resetSeals() {
      seals = {};
      $('#seals').addClass('hidden');
      $('.stat img').addClass('hidden');
      $('.stat').removeClass('seal_on');
      $('.stat input').prop('checked', false);
    }
    function toggleSeal(stat_index) {
      $('#seals_tip').addClass('dismissed');
      $('#save_tip').removeClass('hidden');

      if (seals[stat_index] == 1) {
        $('.stat.stat_' + stat_index).removeClass('seal_on');
        $('.stat.stat_' + stat_index + ' input').prop('checked', false);
        delete seals[stat_index];
        displayStats();
      } else if (Object.keys(seals).length < 3) {
        seals[stat_index] = 1;
        $('.stat.stat_' + stat_index).addClass('seal_on');
        $('.stat.stat_' + stat_index + ' input').prop('checked', true);
        displayStats();
      }

      $('#seals_display').empty();
      let seal_txt = [];
      for (key in seals) {
        if (seals[key]) {
          seal_txt.push(stats[key].label);
        }
      }

      for (let i = seal_txt.length; i < 3; i++) {
        seal_txt.push('x');
      }

      $('#seals_display').text('(' + seal_txt.join(', ') + ')');
    }
    function getTotalMaterials(iname, lv) {
      let mats = {
        awakening: {
          stage: [],
          total: {}
        },
        recipe: {},
        total: {}
      };

      artifactRecipeMap[iname].craft.forEach((material) => {
        switch (material.type) {
          case 0:
            if (mats.total[material.id]) {
              mats.total[material.id].num += material.num;
            } else {
              mats.total[material.id] = material;
            }
            break;
          case 1:
            let item_mats = getTotalMaterials(material.id, material.lv);

            for (let key in item_mats.total) {
              if (mats.total[key]) {
                mats.total[key].num += item_mats.total[key].num;
              } else {
                mats.total[key] = item_mats.total[key];
              }
            }
            break;
        }

        mats.recipe[material.id] = material;
      });

      let artifactAwake = artifactAwakeMap[iname];
      artifactAwake.awakes.forEach((awake, i) => {
        if (awake.lv <= lv) {
          mats.awakening.stage[i] = {};

          for (key in awake) {
            if (key.startsWith('mat')) {
              let mat = awake[key].split(',');

              if (!(mat[0] in mats.total)) {
                mats.total[mat[0]] = 0;
              }

              mats.total[mat[0]] += parseInt(mat[1]);
              mats.awakening.stage[i][mat[0]] = parseInt(mat[1]);
              mats.awakening.total[mat[0]] += parseInt(mat[1]);
            }
          }
        }
      });

      return mats;
    }
    function save(el) {
      if ($('#saved .selectable').length >= 10) {
        return;
      }

      let newEl = $(el).clone();
      let itemKey = $('#artifacts').val();
      let item = artifactMap[itemKey];
      let item_td = $('#skills').clone();
      item_td.attr('colspan', null);
      item_td.attr('id', null);
      item_td.prepend('<div><b>' + item.name + '</b></div>');

      newEl.attr('id', null);
      newEl.attr('onclick', "unsave(this)");
      newEl.prepend(item_td);
      $('#saved table').append(newEl);
      $('#saved .tips').removeClass('hidden');
      $('#saved').removeClass('hidden');
      $('#growth .tips').addClass('dismissed');

      setHash();
    }
    function unsave(el) {
      $(el).remove();

      if ($('#saved .selectable').length == 0) {
        $('#saved').addClass('hidden');
      }

      $('#saved .tips').addClass('dismissed');

      setHash();
    }

    function getArtifactStats(curve, base) {
      let artifact_stats = {};

      stats.forEach((stat) => {
        if (base[stat.value]) {
          if (curve[stat.value]) {
            artifact_stats[stat.value] = (100 + curve[stat.value]) / 100 * base[stat.value];

            let isNeg = artifact_stats[stat.value] < 0;

            artifact_stats[stat.value] = Math.floor(Math.abs(artifact_stats[stat.value]));
            if (isNeg) {
              artifact_stats[stat.value] *= -1;
            }
          } else {
            artifact_stats[stat.value] = base[stat.value];
          }
        }
      });

      return artifact_stats;
    }

    function getArtifactRates(adjust, base) {
      let artifact_rates = {};

      stats.forEach((stat, i) => {
        if (base[stat.value]) {
          if (adjust[stat.value]) {
            artifact_rates[stat.value] = base[stat.value] + adjust[stat.value];
          } else {
            artifact_rates[stat.value] = base[stat.value];
          }

          if (seals[i] && sealGrowthMap[stat.value]) {
            artifact_rates[stat.value] += sealGrowthMap[stat.value];
          }

          if (artifact_rates[stat.value] < 0) {
            artifact_rates[stat.value] = 0;
          }
        }
      });

      return artifact_rates;
    }

    let promiseList = [];
    let loadJP = false;
    location.search.substr(1).split('&').forEach((param) => {
      let params = param.split('=');
      if (params[0] == 'jp') {
        loadJP = true;
      }
    });

    let typeMap = {};
    promiseList.push(new Promise((resolve, reject) => {
      // init
      $.getJSON('en/ArtifactGrow.json', (data) => {
        let typeNameMap = {};
        data.infos.forEach((info) => {
          typeNameMap[info.key] = info.value;
        });
        // 20200422_4c9ea1e3
        $.getJSON((loadJP ? 'jp' : '') + 'data/ArtifactRandLot.json', (data) => {
          data.items.forEach((item) => {
            typeMap[item.iname] = [];
            if (item.lot[0].grow1) {
              typeMap[item.iname].push({
                label: typeNameMap[item.lot[0].grow1],
                value: item.lot[0].grow1
              });
            }
            if (item.lot[0].grow2) {
              typeMap[item.iname].push({
                label: typeNameMap[item.lot[0].grow2],
                value: item.lot[0].grow2
              });
            }
            if (item.lot[0].grow3) {
              typeMap[item.iname].push({
                label: typeNameMap[item.lot[0].grow3],
                value: item.lot[0].grow3
              });
            }
          });

          resolve();
        });
      });
    }));

    let growthMap = {};
    promiseList.push(new Promise((resolve, reject) => {
      // init
      $.getJSON((loadJP ? 'jp' : '') + 'data/Grow.json', (data) => {
        data.items.forEach((item) => {
          growthMap[item.type] = {
            curve: item.curve,
            rstatus : item.rstatus
          }
        });

        resolve();
      });
    }));

    let buffMap = {};
    promiseList.push(new Promise((resolve, reject) => {
      // 20200422_4c9ea1e3
      $.getJSON((loadJP ? 'jp' : '') + 'data/Buff.json', (data) => {
        data.items.forEach((item) => {
          buffMap[item.iname] = item;
        });

        resolve();
      });
    }));

    let buffNameList = [];
    promiseList.push(new Promise((resolve, reject) => {
      // 20200422_4c9ea1e3 translations
      $.getJSON('en/Buff.json', (data) => {
        // pretty sure this is the right list
        // but needs modifications for now
        buffNameList = data.infos;

        // modifications
        // remove first 7
        for (let i = 0; i < 7; i++) {
          buffNameList.splice(0,1);
        }
        // insert 16 dummy
        for (let i = 0; i < 16; i++) {
          buffNameList.splice(5,0,null);
        }
        // insert 12 dummy
        for (let i = 0; i < 11; i++) {
          buffNameList.splice(30,0,null);
        }
        // insert 10 dummy
        for (let i = 0; i < 10; i++) {
          buffNameList.splice(51,0,null);
        }
        // insert 4 dummy
        for (let i = 0; i < 4; i++) {
          buffNameList.splice(66,0,null);
        }
        // insert 10 dummy
        for (let i = 0; i < 10; i++) {
          buffNameList.splice(71,0,null);
        }
        // insert 1 dummy
        for (let i = 0; i < 1; i++) {
          buffNameList.splice(94,0,null);
        }
        // insert 1 dummy
        for (let i = 0; i < 1; i++) {
          buffNameList.splice(118,0,null);
        }
        // insert 10 dummy
        for (let i = 0; i < 10; i++) {
          buffNameList.splice(124,0,null);
        }
        // insert 4 dummy
        for (let i = 0; i < 4; i++) {
          buffNameList.splice(135,0,null);
        }
        // insert 8 dummy
        for (let i = 0; i < 8; i++) {
          buffNameList.splice(143,0,null);
        }
        // insert 10 dummy
        for (let i = 0; i < 10; i++) {
          buffNameList.splice(160,0,null);
        }
        // insert 6 dummy
        for (let i = 0; i < 6; i++) {
          buffNameList.splice(173,0,null);
        }
        // remove 22 Debuff Res
        for (let i = 0; i < 22; i++) {
          buffNameList.splice(183,1);
        }
        // insert 6 dummy
        for (let i = 0; i < 6; i++) {
          buffNameList.splice(184,0,null);
        }

        resolve();
      });
    }));

    let skillMap = {};
    promiseList.push(new Promise((resolve, reject) => {
      // 20200429_0d4b0c72
      $.getJSON((loadJP ? 'jp' : '') + 'data/Skill.json', (data) => {
        data.items.forEach((item) => {
          skillMap[item.iname] = item;
        });

        resolve();
      });
    }));

    let skillNameMap = {};
    promiseList.push(new Promise((resolve, reject) => {
      // 20200429_0d4b0c72
      $.getJSON('en/SkillName.json', (data) => {
        data.infos.forEach((info) => {
          if (info.value) {
            skillNameMap[info.key] = info.value;
          }
        });

        resolve();
      });
    }));

    let artifactNameMap = {};
    let artifactMap = {};
    let artifactListByCat = [];
    promiseList.push(new Promise((resolve, reject) => {
      // 20200422_4c9ea1e3 translations
      $.getJSON('en/ArtifactName.json', (data) => {
        data.infos.forEach((info) => {
          artifactNameMap[info.key] = info.value;
        });

        $.getJSON((loadJP ? 'jp' : '') + 'data/Artifact.json', (data) => {
          data.items.forEach((item) => {
            if (item.type >= 0) {
              if (artifactNameMap[item.iname]) {
                artifactMap[item.iname] = item;
                artifactMap[item.iname].name = artifactNameMap[item.iname];

                let artifactListEntry = {
                  label: artifactNameMap[item.iname],
                  value : item.iname
                };

                item.cat.forEach((cat) => {
                  if (artifactListByCat[cat] == null) {
                    artifactListByCat[cat] = [];
                  }

                  artifactListByCat[cat].push(artifactListEntry);
                });
              }
            }
          });

          artifactListByCat.forEach((artifactList, index, list) => {
            artifactList.sort((a, b) => {
              return a.label > b.label ? 1 : -1;
            });
          });

          resolve();
        });
      });
    }));

    let sealGrowthMap = {};
    promiseList.push(new Promise((resolve, reject) => {
      // init
      $.getJSON((loadJP ? 'jp' : '') + 'data/ArtifactGrowItem.json', (data) => {
        data.items.forEach((item) => {
          let stat = stats[item.grow_up[0].eff_dst];
          sealGrowthMap[stat.value] = item.grow_up[0].val;
        });

        resolve();
      });
    }));

    let artifactCategoryList = [];
    promiseList.push(new Promise((resolve, reject) => {
      // init
      $.getJSON('en/ArtifactCategory.json', (data) => {
        artifactCategoryList = data.infos;

        // for some reason doesn't match exactly
        artifactCategoryList.splice(4,1); // remove LARGESWORD
        artifactCategoryList.splice(6,1); // remove ROD
        artifactCategoryList.splice(18,2); // LIGHTSHIELD, HEAVYSHIELD
        artifactCategoryList.splice(22,3); // LIGHTARMOR, HEAVYARMOR, ROBE

        resolve();
      });
    }));

    // RECIPES
    let artifactRecipeMap = {};
    promiseList.push(new Promise((resolve, reject) => {
      // 20200422_4c9ea1e3
      $.getJSON((loadJP ? 'jp' : '') + 'data/ArtifactRecipe.json', (data) => {
        data.items.forEach((item) => {
          artifactRecipeMap[item.iname] = item;
        });

        resolve();
      });
    }));

    let artifactAwakeMap = {};
    promiseList.push(new Promise((resolve, reject) => {
      // 20200422_4c9ea1e3
      $.getJSON((loadJP ? 'jp' : '') + 'data/ArtifactAwake.json', (data) => {
        data.items.forEach((item) => {
          artifactAwakeMap[item.iname] = item;
        });

        resolve();
      });
    }));

    let itemMap = {};
    promiseList.push(new Promise((resolve, reject) => {
      // 20200506_199950f7
      $.getJSON((loadJP ? 'jp' : '') + 'data/Item.json', (data) => {
        data.items.forEach((item) => {
          itemMap[item.iname] = item;
        });

        resolve();
      });
    }));

    let itemNameMap = {};
    promiseList.push(new Promise((resolve, reject) => {
      // 20200422_4c9ea1e3 translations
      $.getJSON('en/ItemName.json', (data) => {
        data.infos.forEach((info) => {
          itemNameMap[info.key] = info.value;
        });

        resolve();
      });
    }));

    function setHash() {
      let hash = {
        saved: []
      };

      let savedEl = $('#saved .selectable');
      if (savedEl.length > 0) {
        savedEl.each((index, el) => {
          hash.saved.push(el.innerHTML.replace(/(^<td>)|(<\/td>$)/g,'').split('</td><td>'));
        });

        window.location.hash = btoa(JSON.stringify(hash));
      } else {
        window.location.hash = '';
      }
    }

    function getHash(artifact, category, level) {
      return btoa(JSON.stringify({
        artifact: artifact,
        category: category,
        level: level
      }));
    }

    Promise.all(promiseList).then(() => {
      artifactCategoryList.forEach((cat, i) => {
        switch(cat.key) {
          case 'NONE':
          case 'HAMMER':
          case 'INSTRUMENT':
          case 'WHIP':
          case 'THROWING':
          case 'SEPARATOR':
            break;
          default:
            if (artifactListByCat[i]) {
              $('#category').append('<option value="' + i + '">' + cat.value + '</option>');
            }
            break;
        }
      });

      if (window.location.hash) {
        let unhash = JSON.parse(atob(window.location.hash.substr(1)));

        if (unhash.category) {
          $('#category').val(unhash.category);
          $('#category').change();

          if (unhash.artifact) {
            $('#artifacts').val(unhash.artifact);
            $('#artifacts').change();

            if (unhash.level) {
              $('#level').val(unhash.level);
              $('#level').change();
            }
          }
        }

        if (unhash.saved) {
          unhash.saved.forEach((data) => {
            $('#saved table').append('<tr class="selectable" onclick="unsave(this)"><td>' + data.join('</td><td>') + '</td></tr>');
          });

          if ($('#saved .selectable').length > 0) {
            $('#saved').removeClass('hidden');
          }
        }
      }

      $('#category').focus();
    });
  </script>
</body>
</html>
