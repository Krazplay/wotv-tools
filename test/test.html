<!DOCTYPE html>
<html>
<head>
<script src="jquery-3.5.0.min.js" type="text/javascript"></script>
<link href="style.css" rel="stylesheet" type="text/css">
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-164908860-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-164908860-1');
</script>
<title>WotV:FFBE Equipment Calculator</title>
</head>
<body>
  <div id="header">
    <h1>
      Equipment Calculator
    </h1>
  </div>

  <div id="main_content">
    <div id="inputs">
      <select id="artifacts" onchange="onArtifactChange()">
        <option disabled selected>-- Select an equipment --</option>
        <optgroup id="artifacts-weapon" label="Weapons"></optgroup>
        <optgroup id="artifacts-armor" label="Armors"></optgroup>
        <optgroup id="artifacts-accessory" label="Accessories"></optgroup>
        <optgroup id="artifacts-other" label="Others"></optgroup>
      </select>
      <select id="level" class="hidden" onchange="onLevelChange()"></select>
      <span>Click a row below to save!</span>
    </div>

    <div id="content" class="hidden">
      <div class="grid">
        <div class="cell" id="info">
          <table class="borderless">
            <tr>
              <td colspan="2">
                <img id="image" src=""/>
              </td>
            </tr>
            <tr>
              <td><b>Rarity</b></td>
              <td id="rarity"></td>
            </tr>
            <tr>
              <td><b>Type</b></td>
              <td id="type"></td>
            </tr>
            <tr>
              <td id="skills" colspan="2"></td>
            </tr>
          </table>
        </div>

        <div class="cell" id="stats">
          <table>
            <tr>
              <th>Growth Type</th>
              <th>HP</th>
              <th>TP</th>
              <th>AP</th>
              <th>ATK</th>
              <th>DEF</th>
              <th>MAG</th>
              <th>SPR</th>
              <th>ACC</th>
              <th>EVADE</th>
              <th>AGI</th>
              <th>DEX</th>
              <th>CRIT</th>
              <th>CRIT EVADE</th>
            </tr>
            <tr id="grow1_stats" class="selectable" onclick="save(this)"></tr>
            <tr id="grow2_stats" class="selectable" onclick="save(this)"></tr>
            <tr id="grow3_stats" class="selectable" onclick="save(this)"></tr>
          </table>

          <table id="seals" class="hidden">
            <tr>
              <th colspan="8">Seals <span id="seals_display">[x,x,x]</span></th>
            </tr>
            <tr>
              <th class="stat selectable stat_0" onclick="toggleSeal(0)">
                <label for="">HP<br/><img src="img/items/IT_AF_SUP_HP.png"/></label><br/>
                <input type="checkbox" class="hidden" disabled />
              </th>
              <th class="stat selectable stat_3" onclick="toggleSeal(3)">
                <label for="">ATK<br/><img src="img/items/IT_AF_SUP_ATK.png"/></label><br/>
                <input type="checkbox" class="hidden" disabled />
              </th>
              <th class="stat selectable stat_4" onclick="toggleSeal(4)">
                <label for="">DEF<br/><img src="img/items/IT_AF_SUP_DEF.png"/></label><br/>
                <input type="checkbox" class="hidden" disabled />
              </th>
              <th class="stat selectable stat_5" onclick="toggleSeal(5)">
                <label for="">MAG<br/><img src="img/items/IT_AF_SUP_MAG.png"/></label><br/>
                <input type="checkbox" class="hidden" disabled />
              </th>
              <th class="stat selectable stat_6" onclick="toggleSeal(6)">
                <label for="">SPR<br/><img src="img/items/IT_AF_SUP_MND.png"/></label><br/>
                <input type="checkbox" class="hidden" disabled />
              </th>
              <th class="stat selectable stat_7" onclick="toggleSeal(7)">
                <label for="">ACC<br/><img src="img/items/IT_AF_SUP_HIT.png"/></label><br/>
                <input type="checkbox" class="hidden" disabled />
              </th>
              <th class="stat selectable stat_10" onclick="toggleSeal(10)">
                <label for="">EVADE<br/><img src="img/items/IT_AF_SUP_AVO.png"/></label><br/>
                <input type="checkbox" class="hidden" disabled />
              </th>
              <th class="stat selectable stat_11" onclick="toggleSeal(11)">
                <label for="">CRIT<br/><img src="img/items/IT_AF_SUP_CRI.png"/></label><br/>
                <input type="checkbox" class="hidden" disabled />
              </th>
            </tr>
          </table>
        </div>
      </div>

      <div class="grid">
        <div class="cell">
          <table id="recipe"></table>
        </div>
        <div class="cell">
          <table id="total_mats"></table>
        </div>
      </div>
    </div>

    <div class="grid hidden">
      <h3>Saved Equipment <span onclick="copyLink">Copy</span></h3>
      <textarea class="hidden" id="copy_txt"></textarea>
      <table id="saved">
        <tr>
          <th>Equipment</th>
          <th>Type</th>
          <th>HP</th>
          <th>TP</th>
          <th>AP</th>
          <th>ATK</th>
          <th>DEF</th>
          <th>MAG</th>
          <th>SPR</th>
          <th>ACC</th>
          <th>DEX</th>
          <th>AGI</th>
          <th>EVA</th>
          <th>CRIT</th>
          <th>CRIT.A</th>
        </tr>
      </table>
    </div>
  </div>

  <footer>
    <a target="_blank" href="changelogs.html">Change Logs (2020-05-07)</a> |
    <a target="_blank" href="https://github.com/wotv-tools/wotv-tools.github.io/issues/new">Report Issues</a> |
    <a target="_blank" href="https://github.com/shalzuth/wotv-ffbe-dump">Data source</a> |
    <a target="_blank" href="legal.html">Legal</a>
  </footer>

  <script>
    let mat_link = 'https://wotvfarmcalculator.github.io/?i=';
    let stats = [{
      label: "HP",
      value: "hp"
    }, {
      label: "TP",
      value: "mp"
    }, {
      label: "AP",
      value: "ap"
    }, {
      label: "ATK",
      value: "atk"
    }, {
      label: "DEF",
      value: "def"
    }, {
      label: "MAG",
      value: "mag"
    }, {
      label: "SPR",
      value: "mnd"
    }, {
      label: "ACC",
      value: "hit"
    }, {
      label: "DEX",
      value: "dex"
    }, {
      label: "AGI",
      value: "spd"
    }, {
      label: "EVA",
      value: "avd"
    }, {
      label: "CRIT",
      value: "crt"
    }, {
      label: "CRIT.A",
      value: "crta"
    }];

    function onArtifactChange() {
      resetSeals();
      setItemInfo();
    }
    function onLevelChange() {
      displayStats();
    }

    function displayStats() {
      let itemKey = $('#artifacts').val();
      if (!itemKey) {
        return;
      }

      let item = artifactMap[itemKey];
      let level = $('#level').val();
      let item_sk = item['skl' + (level/10)];

      $('#image').attr('src', 'img/equipment/' + item.asset + '.png');

      $('#type').empty();
      item.cat.forEach((cat) => {
        $('#type').append('<div>' + artifactCategoryList[cat].value + '</div>');
      });

      $('#rarity').empty();
      switch (item.rare) {
        case 0:
          $('#rarity').append('<div>N</div>');
          break;
        case 1:
          $('#rarity').append('<div>R</div>');
          break;
        case 2:
          $('#rarity').append('<div>SR</div>');
          break;
        case 3:
          $('#rarity').append('<div>MR</div>');
          break;
        case 4:
          $('#rarity').append('<div>UR</div>');
          break;
      }

      $('#skills').empty();
      if (item_sk) {
        item_sk.forEach((skl) => {
          let skill = skillMap[skl];
          if (skill.s_buffs) {
            skill.s_buffs.forEach((s_buff) => {
              let buff = buffMap[s_buff];
              let buff_text, killer_index_offset;

              switch (buff.type1) {
                // Elemental Killer
                case 119:
                  killer_index_offset = 76;
                  buff_text = buffNameList[buff.type1 + buff.tag1[0] + killer_index_offset].value + ' ' + buff.val1;
                  break;
                // Species Killer
                case 120:
                  killer_index_offset = -8;
                  buff_text = buffNameList[buff.type1 + buff.tag1[0] + killer_index_offset].value + ' ' + buff.val1;
                  break;
                // Condition Granted
                case 123:
                  let buff2 = buffMap[buff.id1];
                  buff_text = buffNameList[buff2.type1].value + ' Granted (' + buff2.turn + ' turns, ' + buff2.rate + '%)';
                  break;
                default:
                  buff_text = buffNameList[buff.type1].value;

                  switch (buff.calc1) {
                    case 3:
                      buff_text += ' Res';
                      break;
                  }

                  buff_text += ' ' + buff.val1
                  break;
              }
              $('#skills').append('<div>' + buff_text + '</div>');
            });
          } else if (skillNameMap[skl]) {
              $('#skills').append('<div>' + skillNameMap[skl] + '</div>');
          }
        });
      }
      if (!$.trim($('#skills').html())) {
          $('#skills').append('<div>-</div>');
      }

      // $('#desc').empty();
      // $('#desc').append(artifactFlavorMap[item.iname]);

      $('#grow1_stats').empty();
      $('#grow2_stats').empty();
      $('#grow3_stats').empty();
      let types = typeMap[item.rtype];

      types.forEach((type, i) => {
        let typeGrowth = growthMap[type.value];
        let typeStatsRow = $('#grow' + (i+1) + '_stats');
        let artifact_stats, artifact_rates, ave_stats;

        switch (type.value) {
          case 'ARTIFACT_TRUST':
            artifact_stats = item.status[1];
            ave_stats = item.status[1];
            break;
          case 'ARTIFACT_50':
            artifact_stats = item.status[1];
            ave_stats = Object.assign({}, item.status[0]);

            stats.forEach((stat) => {
              if (!isNaN(artifact_stats[stat.value])) {
                // guessing growth for no rstatus growth
                ave_stats[stat.value] = item.status[0][stat.value] + (item.status[1][stat.value] - item.status[0][stat.value]) * Math.min(level-1, typeGrowth.curve[0].lv-1) / (typeGrowth.curve[0].lv-1);
              }
            });

            break;
          default:
            artifact_stats = getArtifactStats(typeGrowth.curve[0], item.status[1]);
            artifact_rates = getArtifactRates(typeGrowth.rstatus[0], item.randr[0]);
            ave_stats = Object.assign({}, item.status[0]);

            for (let i = 1; i < level; i++) {
              let pity_rate = 1;
              let pity_stat;

              stats.forEach((stat) => {
                if (!isNaN(artifact_stats[stat.value])) {
                  ave_stats[stat.value] += item.randa[0][stat.value] * artifact_rates[stat.value] / 100;
                  pity_rate *= (1 - (artifact_rates[stat.value] / 100));

                  if (!pity_stat || artifact_rates[stat.value] > artifact_rates[pity_stat]) {
                      pity_stat = stat.value;
                  }

                  if (ave_stats[stat.value] > artifact_stats[stat.value]) {
                    ave_stats[stat.value] = artifact_stats[stat.value];
                    artifact_rates[stat.value] = 0;
                  }
                }
              });

              // add pity
              ave_stats[pity_stat] += pity_rate;
              if (ave_stats[pity_stat] > artifact_stats[pity_stat]) {
                ave_stats[pity_stat] = artifact_stats[pity_stat];
                artifact_rates[pity_stat] = 0;
              }
            }
            break;
        }

        typeStatsRow.append('<td><b>' + (type.label ? type.label : '-') + '</b></td>');
        stats.forEach((stat, i) => {
          if (ave_stats[stat.value] > artifact_stats[stat.value]) {
            ave_stats[stat.value] = artifact_stats[stat.value];
            artifact_rates[stat.value] = 0;
          } else {
            ave_stats[stat.value] = Math.round(ave_stats[stat.value]);
          }

          if (!isNaN(artifact_stats[stat.value] && item.status[0][stat.value] != 0 && artifact_stats[stat.value] != 0)) {
            $('.stat.stat_' + stat.value).removeClass('hidden');
            if (seals[i]) {
              typeStatsRow.append('<td><b>' + ave_stats[stat.value] + '</b> / ' + artifact_stats[stat.value] + '</td>');
            } else {
              typeStatsRow.append('<td>' + ave_stats[stat.value] + ' / ' + artifact_stats[stat.value] + '</td>');
            }
          } else {
            typeStatsRow.append('<td> - </td>');
          }
        });
      });

      // get recipe
      $('#recipe_table').addClass('hidden');
      $('#recipe').empty();
      $('#total_mats').empty();
      if (artifactRecipeMap[item.iname]) {
        $('#recipe').append('<tr><th colspan="2">Recipe</th></tr>');

        let all_mats = [];
        artifactRecipeMap[item.iname].craft.forEach((material) => {
          let itemName = 'UNKNOWN';
          let mat_url;
          let tr = $('<tr></tr>');

          tr.append('<td>' + material.num + 'x</td>');

          switch (material.type) {
            case 0:
              itemName = itemNameMap[material.id];
              mat_url = mat_link + encodeURIComponent(itemName);
              all_mats.push(itemName);
              break;
            case 1:
              mat_url = '#' + getHash(material.id, material.lv);
              itemName = artifactNameMap[material.id] + ' Lv. ' + material.lv;
              break;
          }
          tr.append('<td><a target="_blank" href="' + mat_url + '">' + itemName + '</a></td>');
          $('#recipe').append(tr);
        });

        $('#total_mats').append('<tr><th colspan="2">Total Materials</th></tr>');
        let mats_total = getTotalMaterials(item.iname, level);
        for (mat in mats_total) {
          let itemName = itemNameMap[mat];
          let mat_url = mat_link + encodeURIComponent(itemName);
          let img_url = '/img/items/' + mat + '.png';
          let tr = $('<tr></tr>');
          tr.append('<td>' + mats_total[mat] + 'x</td>');
          // tr.append('<td><img src="' + img_url + '"/></td>');
          tr.append('<td><a target="_blank" href="' + mat_url + '">' + itemName + '</a></td>');
          $('#total_mats').append(tr);
        }
        $('#recipe_table').removeClass('hidden');
      }

      $('#content').removeClass('hidden');
    }

    function setItemInfo() {
      let itemKey = $('#artifacts').val();
      if (!itemKey) {
        return;
      }

      let item = artifactMap[itemKey];
      let types = typeMap[item.rtype];

      $('#level').empty();
      $('#seals').addClass('hidden');
      switch (types[0].value) {
        case 'ARTIFACT_TRUST':
          $('#level').append('<option value="1">Lv. 1</option>');
          $('#level').val('1');
          break;
        case 'ARTIFACT_50':
          $('#level').append('<option value="1">Lv. 1</option>');
          $('#level').append('<option value="10">Lv. 10</option>');
          $('#level').append('<option value="20">Lv. 20</option>');
          $('#level').append('<option value="30">Lv. 30</option>');
          $('#level').val('30');
          break;
        default:
          $('#level').append('<option value="1">Lv. 1</option>');
          $('#level').append('<option value="10">Lv. 10</option>');
          $('#level').append('<option value="20">Lv. 20</option>');
          $('#level').append('<option value="30">Lv. 30</option>');
          $('#level').append('<option value="40">Lv. 40</option>');
          $('#level').append('<option value="50">Lv. 50</option>');
          $('#level').val('50');

          stats.forEach((stat, i) => {
            if (item.status[1][stat.value] != null) {
              $('#seals .stat_' + i).removeClass('hidden');
            }
          });

          $('#seals').removeClass('hidden');
          break;
      }
      $('#level').removeClass('hidden');
      $('#level').change();
    }

    let seals = {}
    function resetSeals() {
      seals = {};
      $('#seals').addClass('hidden');
      $('.stat').addClass('hidden');
      $('.stat input').prop('checked', false);
    }
    function toggleSeal(stat_index) {
      if (seals[stat_index] == 1) {
        $('.stat.stat_' + stat_index + ' input').prop('checked', false);
        delete seals[stat_index];
        displayStats();
      } else if (Object.keys(seals).length < 3) {
        seals[stat_index] = 1;
        $('.stat.stat_' + stat_index + ' input').prop('checked', true);
        displayStats();
      }

      $('#seals_display').empty();
      let seal_txt = [];
      for (key in seals) {
        if (seals[key]) {
          seal_txt.push(stats[key].label);
        }
      }

      for (let i = seal_txt.length; i < 3; i++) {
        seal_txt.push('x');
      }

      $('#seals_display').text('(' + seal_txt.join(', ') + ')');
    }
    function getTotalMaterials(iname, lv) {
      let mat_list = {};

      artifactRecipeMap[iname].craft.forEach((material) => {
        switch (material.type) {
          case 0:
            let itemName = itemNameMap[material.id];

            if (!(material.id in mat_list)) {
              mat_list[material.id] = 0;
            }

            mat_list[material.id] += material.num;
            break;
          case 1:
            let item_mat_list = getTotalMaterials(material.id, material.lv);

            for (key in item_mat_list) {
              if (!(key in mat_list)) {
                mat_list[key] = 0;
              }

              mat_list[key] += item_mat_list[key];
            }
            break;
        }
      });

      let artifactAwake = artifactAwakeMap[iname];
      artifactAwake.awakes.forEach((awake) => {
        if (awake.lv <= lv) {
          for (key in awake) {
            if (key.startsWith('mat')) {
              let mat = awake[key].split(',');

              if (!(mat[0] in mat_list)) {
                mat_list[mat[0]] = 0;
              }

              mat_list[mat[0]] += parseInt(mat[1]);
            }
          }
        }
      });

      return mat_list;
    }
    function save(el) {
      if ($('#saved .selectable').length >= 10) {
        return;
      }

      let newEl = $(el).clone();
      let itemKey = $('#artifacts').val();
      let item = artifactMap[itemKey];
      let item_td = $('#skills').clone();
      item_td.attr('colspan', null);
      item_td.attr('id', null);
      item_td.prepend('<div><b>' + item.name + '</b></div>');

      newEl.attr('id', null);
      newEl.attr('onclick', "unsave(this)");
      newEl.prepend(item_td);
      $('#saved').append(newEl);
      $('#saved').parent('div.grid').removeClass('hidden');

      setHash();
    }
    function copyLink() {
      let copyTxt = $('#copy_txt');
      copyTxt.val(window.location);
      copyTxt.focus();
      copyTxt.setSelectionRange(0, copyTxt.value.length);

      if (document.execCommand('copy')) {
        alert('Saved to clipboard!');
      }
    }
    function unsave(el) {
      $(el).remove();

      if ($('#saved .selectable').length == 0) {
        $('#saved').parent('div.grid').addClass('hidden');
      }

      setHash();
    }

    function getArtifactStats(curve, base) {
      let artifact_stats = {};

      stats.forEach((stat) => {
        if (base[stat.value]) {
          if (curve[stat.value]) {
            artifact_stats[stat.value] = (100 + curve[stat.value]) / 100 * base[stat.value];

            let isNeg = artifact_stats[stat.value] < 0;

            artifact_stats[stat.value] = Math.floor(Math.abs(artifact_stats[stat.value]));
            if (isNeg) {
              artifact_stats[stat.value] *= -1;
            }
          } else {
            artifact_stats[stat.value] = base[stat.value];
          }
        }
      });

      return artifact_stats;
    }

    function getArtifactRates(adjust, base) {
      let artifact_rates = {};

      stats.forEach((stat, i) => {
        if (base[stat.value]) {
          if (adjust[stat.value]) {
            artifact_rates[stat.value] = base[stat.value] + adjust[stat.value];
          } else {
            artifact_rates[stat.value] = base[stat.value];
          }

          if (seals[i] && sealGrowthMap[stat.value]) {
            artifact_rates[stat.value] += sealGrowthMap[stat.value];
          }

          if (artifact_rates[stat.value] < 0) {
            artifact_rates[stat.value] = 0;
          }
        }
      });

      return artifact_rates;
    }

    let promiseList = [];

    let typeMap = {};
    promiseList.push(new Promise((resolve, reject) => {
      // init
      $.getJSON('en/ArtifactGrow.json', (data) => {
        let typeNameMap = {};
        data.infos.forEach((info) => {
          typeNameMap[info.key] = info.value;
        });
        // 20200422_4c9ea1e3
        $.getJSON('data/ArtifactRandLot.json', (data) => {
          data.items.forEach((item) => {
            typeMap[item.iname] = [];
            if (item.lot[0].grow1) {
              typeMap[item.iname].push({
                label: typeNameMap[item.lot[0].grow1],
                value: item.lot[0].grow1
              });
            }
            if (item.lot[0].grow2) {
              typeMap[item.iname].push({
                label: typeNameMap[item.lot[0].grow2],
                value: item.lot[0].grow2
              });
            }
            if (item.lot[0].grow3) {
              typeMap[item.iname].push({
                label: typeNameMap[item.lot[0].grow3],
                value: item.lot[0].grow3
              });
            }
          });

          resolve();
        });
      });
    }));

    let growthMap = {};
    promiseList.push(new Promise((resolve, reject) => {
      // init
      $.getJSON('data/Grow.json', (data) => {
        data.items.forEach((item) => {
          growthMap[item.type] = {
            curve: item.curve,
            rstatus : item.rstatus
          }
        });

        resolve();
      });
    }));

    let buffMap = {};
    promiseList.push(new Promise((resolve, reject) => {
      // 20200422_4c9ea1e3
      $.getJSON('data/Buff.json', (data) => {
        data.items.forEach((item) => {
          buffMap[item.iname] = item;
        });

        resolve();
      });
    }));

    let buffNameList = [];
    promiseList.push(new Promise((resolve, reject) => {
      // 20200422_4c9ea1e3 translations
      $.getJSON('en/Buff.json', (data) => {
        // pretty sure this is the right list
        // but needs modifications for now
        buffNameList = data.infos;

        // modifications
        // remove first 7
        for (let i = 0; i < 7; i++) {
          buffNameList.splice(0,1);
        }
        // insert 16 dummy
        for (let i = 0; i < 16; i++) {
          buffNameList.splice(5,0,null);
        }
        // insert 12 dummy
        for (let i = 0; i < 11; i++) {
          buffNameList.splice(30,0,null);
        }
        // insert 10 dummy
        for (let i = 0; i < 10; i++) {
          buffNameList.splice(51,0,null);
        }
        // insert 4 dummy
        for (let i = 0; i < 4; i++) {
          buffNameList.splice(66,0,null);
        }
        // insert 10 dummy
        for (let i = 0; i < 10; i++) {
          buffNameList.splice(71,0,null);
        }
        // insert 1 dummy
        for (let i = 0; i < 1; i++) {
          buffNameList.splice(94,0,null);
        }
        // insert 1 dummy
        for (let i = 0; i < 1; i++) {
          buffNameList.splice(118,0,null);
        }
        // insert 10 dummy
        for (let i = 0; i < 10; i++) {
          buffNameList.splice(124,0,null);
        }
        // insert 4 dummy
        for (let i = 0; i < 4; i++) {
          buffNameList.splice(135,0,null);
        }
        // insert 8 dummy
        for (let i = 0; i < 8; i++) {
          buffNameList.splice(143,0,null);
        }
        // insert 10 dummy
        for (let i = 0; i < 10; i++) {
          buffNameList.splice(160,0,null);
        }
        // insert 7 dummy
        for (let i = 0; i < 7; i++) {
          buffNameList.splice(173,0,null);
        }
        // remove 22 Debuff Res
        for (let i = 0; i < 22; i++) {
          buffNameList.splice(183,1);
        }
        // insert 6 dummy
        for (let i = 0; i < 6; i++) {
          buffNameList.splice(184,0,null);
        }

        resolve();
      });
    }));

    let skillMap = {};
    promiseList.push(new Promise((resolve, reject) => {
      // 20200429_0d4b0c72
      $.getJSON('data/Skill.json', (data) => {
        data.items.forEach((item) => {
          skillMap[item.iname] = item;
        });

        resolve();
      });
    }));

    let skillNameMap = {};
    promiseList.push(new Promise((resolve, reject) => {
      // 20200429_0d4b0c72
      $.getJSON('en/SkillName.json', (data) => {
        data.infos.forEach((info) => {
          if (info.value) {
            skillNameMap[info.key] = info.value;
          }
        });

        resolve();
      });
    }));

    let artifactNameMap = {};
    promiseList.push(new Promise((resolve, reject) => {
      // 20200422_4c9ea1e3 translations
      $.getJSON('en/ArtifactName.json', (data) => {
        data.infos.forEach((info) => {
          artifactNameMap[info.key] = info.value;
        });

        resolve();
      });
    }));

    let sealGrowthMap = {};
    promiseList.push(new Promise((resolve, reject) => {
      // init
      $.getJSON('data/ArtifactGrowItem.json', (data) => {
        data.items.forEach((item) => {
          let stat = stats[item.grow_up[0].eff_dst];
          sealGrowthMap[stat.value] = item.grow_up[0].val;
        });

        resolve();
      });
    }));

    let artifactCategoryList = [];
    promiseList.push(new Promise((resolve, reject) => {
      // init
      $.getJSON('en/ArtifactCategory.json', (data) => {
        artifactCategoryList = data.infos;

        // for some reason doesn't match exactly
        artifactCategoryList.splice(4,1); // remove LARGESWORD
        artifactCategoryList.splice(6,1); // remove ROD
        artifactCategoryList.splice(18,2); // LIGHTSHIELD, HEAVYSHIELD
        artifactCategoryList.splice(22,3); // LIGHTARMOR, HEAVYARMOR, ROBE

        resolve();
      });
    }));

    let artifactMap = {};
    promiseList.push(new Promise((resolve, reject) => {
      // 	20200422_4c9ea1e3
      $.getJSON('data/Artifact.json', (data) => {
        let artifactList = [];
        let artifactWeaponList = [];
        let artifactArmorList = [];
        let artifactAccessoryList = [];
        data.items.forEach((item) => {
          if (item.type >= 0) {
            artifactMap[item.iname] = item;
            artifactMap[item.iname].name = artifactNameMap[item.iname];

            let artifactListEntry = {
              label: artifactNameMap[item.iname],
              value : item.iname
            };

            if (item.cat[0] > 0 && item.cat[0] < 17) {
              artifactWeaponList.push(artifactListEntry);
            } else if (item.cat[0] < 22) {
              artifactArmorList.push(artifactListEntry);
            } else if (item.cat[0] == 22) {
              artifactAccessoryList.push(artifactListEntry);
            } else {
              artifactList.push(artifactListEntry);
            }
          }
        });

        artifactWeaponList.sort((a, b) => {
          return a.label > b.label ? 1 : -1;
        }).forEach((item) => {
          if (item.label) {
            $('#artifacts-weapon').append('<option value="' + item.value +'">' + item.label + '</option>');
          }
        });
        artifactArmorList.sort((a, b) => {
          return a.label > b.label ? 1 : -1;
        }).forEach((item) => {
          if (item.label) {
            $('#artifacts-armor').append('<option value="' + item.value +'">' + item.label + '</option>');
          }
        });
        artifactAccessoryList.sort((a, b) => {
          return a.label > b.label ? 1 : -1;
        }).forEach((item) => {
          if (item.label) {
            $('#artifacts-accessory').append('<option value="' + item.value +'">' + item.label + '</option>');
          }
        });
        artifactList.sort((a, b) => {
          return a.label > b.label ? 1 : -1;
        }).forEach((item) => {
          if (item.label) {
            $('#artifacts-other').append('<option value="' + item.value +'">' + item.label + '</option>');
          }
        });

        $('#artifacts').focus();

        resolve();
      });
    }));

    let artifactFlavorMap = {};
    promiseList.push(new Promise((resolve, reject) => {
      // 20200422_4c9ea1e3 translations
      $.getJSON('en/ArtifactFlvr.json', (data) => {
        data.infos.forEach((info) => {
          artifactFlavorMap[info.key] = info.value;
        });

        resolve();
      });
    }));

    // RECIPES
    let artifactRecipeMap = {};
    promiseList.push(new Promise((resolve, reject) => {
      // 20200422_4c9ea1e3
      $.getJSON('data/ArtifactRecipe.json', (data) => {
        data.items.forEach((item) => {
          artifactRecipeMap[item.iname] = item;
        });

        resolve();
      });
    }));

    let artifactAwakeMap = {};
    promiseList.push(new Promise((resolve, reject) => {
      // 20200422_4c9ea1e3
      $.getJSON('data/ArtifactAwake.json', (data) => {
        data.items.forEach((item) => {
          artifactAwakeMap[item.iname] = item;
        });

        resolve();
      });
    }));

    let itemNameMap = {};
    promiseList.push(new Promise((resolve, reject) => {
      // 20200422_4c9ea1e3 translations
      $.getJSON('en/ItemName.json', (data) => {
        data.infos.forEach((info) => {
          itemNameMap[info.key] = info.value;
        });

        resolve();
      });
    }));

    function setHash() {
      let hash = {
        saved: []
      };

      let savedEl = $('#saved .selectable');
      if (savedEl.length > 0) {
        savedEl.each((index, el) => {
          hash.saved.push(el.innerHTML.replace(/(^<td>)|(<\/td>$)/g,'').split('</td><td>'));
        });

        window.location.hash = btoa(JSON.stringify(hash));
      } else {
        window.location.hash = '';
      }
    }

    function getHash(artifact, level) {
      return btoa(JSON.stringify({
        artifact: artifact,
        level: level
      }));
    }

    Promise.all(promiseList).then(() => {
      if (window.location.hash) {
        let unhash = JSON.parse(atob(window.location.hash.substr(1)));

        if (unhash.artifact) {
          $('#artifacts').val(unhash.artifact);
          $('#artifacts').change();
        }
        if (unhash.level) {
          $('#level').val(unhash.level);
          $('#level').change();
        }

        if (unhash.saved) {
          unhash.saved.forEach((data) => {
            $('#saved').append('<tr class="selectable" onclick="unsave(this)"><td>' + data.join('</td><td>') + '</td></tr>');
          });

          if ($('#saved .selectable').length > 0) {
            $('#saved').parent('div.grid').removeClass('hidden');
          }
        }
      }
    });
  </script>
</body>
</html>
