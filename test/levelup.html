<!DOCTYPE html>
<html>
<head>
<script src="jquery-3.5.0.min.js" type="text/javascript"></script>
<link href="base.css" rel="stylesheet" type="text/css">
<link id="theme" href="dark.css" rel="stylesheet" type="text/css">
<script>
  if (window.localStorage.getItem('light')) {
    $('head #theme').attr('href', 'light.css');
  }
  function toggleCSS() {
    if (window.localStorage.getItem('light')) {
      window.localStorage.removeItem('light');
      $('head #theme').attr('href', 'dark.css');
    } else {
      window.localStorage.setItem('light', true);
      $('head #theme').attr('href', 'light.css');
    }
  }
</script>
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-164908860-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-164908860-1');
</script>
<title>WotV:FFBE Equipment Calculator</title>
</head>
<body>
  <div id="header">
    Equipment Calculator
    <div id="css_toggle" onclick="toggleCSS()">
      <img id="light" src="img/items/IT_UN_AW_SHINE.png" title="Turn off Dark Mode"/>
      <img id="dark" src="img/items/IT_UN_AW_DARK.png" title="Turn on Dark Mode"/>
    </div>
    <div id="support_link">
      <a target="_blank" href="https://www.buymeacoffee.com/sairenkao">
        <img src="img/items/IT_LP_WW_01.png" title="Buy me visiore"/>
        <span>Buy me visiore</span>
      </a>
    </div>
  </div>

  <div id="main_content">
    <div id="start_tip" class="tips">
      <div class="speech_bubble speech_ramada">
        Welcome! This tool will TRY to calculate if you can max all the stats on your item. DISCLAIMER: This tool is still a Work In Progress and may give bad advice! Use at your own risk.
      </div>
    </div>

    <div id="inputs">
      <select id="category" onchange="onCategoryChange()">
        <option disabled selected>-- Select an category --</option>
      </select>
      <select id="artifacts" class="hidden" onchange="onArtifactChange()">
        <optgroup id="artifacts-weapon" label="Weapon"></optgroup>
        <optgroup id="artifacts-armor" label="Armor"></optgroup>
        <optgroup id="artifacts-accessory" label="Accessory"></optgroup>
      </select>
      <select id="types" class="hidden" onchange="onTypeChange()"></select>
      <button id="advice" class="hidden" onclick="getAdvice()">Check Advice</button>
    </div>

    <div id="content" class="hidden">
      <div class="grid">
        <div class="cell" id="grow">
          <div class="cell_content">
            <table id="stats">
              <tr>
                <th style="width: 5%">
                  <div id="item_image" class="equipment">
                    <img src=""/>
                  </div>
                </th>
                <th>Level</th>
                <th>Hammers</th>
                <th>HP</th>
                <th>TP</th>
                <th>AP</th>
                <th>ATK</th>
                <th>DEF</th>
                <th>MAG</th>
                <th>SPR</th>
                <th>ACC</th>
                <th>DEX</th>
                <th>AGI</th>
                <th>EVADE</th>
                <th>CRIT</th>
                <th>CRIT<br/>EVADE</th>
              </tr>
              <tr id="cur_stats"></tr>
              <tr id="growth_amt"></tr>
              <tr id="left_stats"></tr>
              <tr id="max_stats"></tr>
            </table>
          </div>
          <div id="next_step" class="tips hidden">
            <div class="speech_bubble"></div>
          </div>
          <div id="details" class="tips hidden">
            <div class="speech_bubble"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <footer>
    <a href="https://www.reddit.com/r/wotv_ffbe/comments/gd685f/lets_congregate_some_resources/">Other WotV Resources</a> |
    <a target="_blank" href="changelogs.html">Change Logs (Last updated 2020-06-10)</a> |
    <a target="_blank" href="https://github.com/wotv-tools/wotv-tools.github.io/issues/new">Report Issues</a> |
    <a target="_blank" href="https://github.com/shalzuth/wotv-ffbe-dump">Data source</a> |
    <a target="_blank" href="legal.html">Legal</a>
  </footer>

  <script>
    let stats = [{
      label: "HP",
      value: "hp"
    }, {
      label: "TP",
      value: "mp"
    }, {
      label: "AP",
      value: "ap"
    }, {
      label: "ATK",
      value: "atk"
    }, {
      label: "DEF",
      value: "def"
    }, {
      label: "MAG",
      value: "mag"
    }, {
      label: "SPR",
      value: "mnd"
    }, {
      label: "ACC",
      value: "hit"
    }, {
      label: "DEX",
      value: "dex"
    }, {
      label: "AGI",
      value: "spd"
    }, {
      label: "EVA",
      value: "avd"
    }, {
      label: "CRIT",
      value: "crt"
    }, {
      label: "CRIT EVADE",
      value: "crta"
    }];

    function dismiss(el) {
      $(el).addClass('dismissed');
    }

    function onCategoryChange() {
      let category = $('#category').val();

      $('#artifacts').empty();
      artifactListByCat[category].forEach((artifact) => {
        $('#artifacts').append('<option value="' + artifact.value + '">' + artifact.label + '</option>');
      });

      $('#artifacts').removeClass('hidden');
      $('#types').removeClass('hidden');
      $('#artifacts').change();
    }
    function onArtifactChange() {
      setItemInfo();
      $('#types').change();
    }
    function onTypeChange() {
      // $('#start_tip').addClass('dismissed');
      displayStats();
    }

    function setItemInfo() {
      let itemKey = $('#artifacts').val();
      if (!itemKey) {
        return;
      }

      let item = artifactMap[itemKey];
      $('#item_image img').attr('src', 'img/equipment/' + item.asset + '.png');
      $('#item_image').removeClass().addClass('equipment');
      if (item.cat[0] > 0 && item.cat[0] < 17) {
        $('#item_image').addClass('weapon');
      } else if (item.cat[0] < 22) {
        $('#item_image').addClass('armor');
      } else if (item.cat[0] == 22) {
        $('#item_image').addClass('accessory');
      }
      $('#content').removeClass('hidden');

      $('#types').empty();
      let types = typeMap[item.rtype];
      types.forEach((type, i) => {
        $('#types').append('<option value="' + type.value + '">' + type.label + '</option>');
      });
    }

    let max_level = 50;
    function displayStats() {
      let itemKey = $('#artifacts').val();
      let type = $('#types').val();
      if (!itemKey || !type) {
        return;
      }
      let item = artifactMap[itemKey];

      $('#cur_stats').empty();
      $('#growth_amt').empty();
      $('#max_stats').empty();

      $('#cur_stats').append('<td>Current</td>');
      $('#growth_amt').append('<td>Per Level</td>');
      $('#max_stats').append('<td>Max</td>');

      $('#cur_stats').append('<td><input id="levels" onchange="hideAdvice()" type="number" min="1" max="50" value="1" /></td>');
      $('#growth_amt').append('<td></td>');
      $('#max_stats').append('<td>' + max_level + '</td>');

      $('#cur_stats').append('<td><input id="hammers" onchange="hideAdvice()" type="number" min="0" max="' + item.hnum + '" value="0" /></td>');
      $('#growth_amt').append('<td></td>');
      $('#max_stats').append('<td>' + item.hnum + '</td>');

      let typeGrowth = growthMap[type];
      let artifact_stats = getArtifactStats(typeGrowth.curve[0], item.status[1])
      stats.forEach((stat) => {
        let statCell = $('<td></td>');
        if (!isNaN(artifact_stats[stat.value]) && artifact_stats[stat.value] > item.status[0][stat.value]) {
          statCell.append('<input class="stat stat_' + stat.value + '" onchange="hideAdvice()" type="number" min="' + item.status[0][stat.value] + '" value="' + item.status[0][stat.value] + '"/>');
          $('#growth_amt').append('<td>' + item.randa[0][stat.value] + '</td>');
          $('#max_stats').append('<td>' + artifact_stats[stat.value] + '</td>');
        } else {
          statCell.text('-');
          $('#growth_amt').append('<td>-</td>');
          $('#max_stats').append('<td>-</td>');
        }
        $('#cur_stats').append(statCell);
      });

      hideAdvice();

      $('#advice').removeClass('hidden');
    }

    function getArtifactStats(curve, base) {
      let artifact_stats = {};

      stats.forEach((stat) => {
        if (base[stat.value]) {
          if (curve[stat.value]) {
            artifact_stats[stat.value] = (100 + curve[stat.value]) / 100 * base[stat.value];

            let isNeg = artifact_stats[stat.value] < 0;

            artifact_stats[stat.value] = Math.floor(Math.abs(artifact_stats[stat.value]));
            if (isNeg) {
              artifact_stats[stat.value] *= -1;
            }
          } else {
            artifact_stats[stat.value] = base[stat.value];
          }
        }
      });

      return artifact_stats;
    }

    function hideAdvice() {
      let itemKey = $('#artifacts').val();
      let type = $('#types').val();

      if (!itemKey || !type) {
        return;
      }

      let item = artifactMap[itemKey];
      let level = parseInt($('#levels').val());
      let levels_left = max_level - level;
      let hammers = parseInt($('#hammers').val());
      let hammers_left = item.hnum - hammers;

      $('#left_stats').empty();
      $('#left_stats').append('<td>Left</td>');
      $('#left_stats').append('<td></td>');
      $('#left_stats').append('<td></td>');

      let typeGrowth = growthMap[type];
      let artifact_stats = getArtifactStats(typeGrowth.curve[0], item.status[1])
      let total = 0;
      stats.forEach((stat) => {
        if (!isNaN(artifact_stats[stat.value]) && artifact_stats[stat.value] > item.status[0][stat.value]) {
          let cur_stat = parseInt($('#cur_stats .stat_' + stat.value).val());
          let stat_left = artifact_stats[stat.value] - cur_stat;
          $('#left_stats').append('<td>' + stat_left + '</td>');
          total += stat_left;
        } else {
          $('#left_stats').append('<td>-</td>');
        }
      });

      $('#left_stats').append('<td>' + total + '</td>');

      $('#next_step').addClass('hidden');
      $('#details').addClass('hidden');
    }

    function getAdvice() {
      let text = calcAdvice();

      $('#next_step .speech_bubble').text(text);
      $('#next_step').removeClass('hidden');
      $('#details').removeClass('hidden');
    }

    function calcAdvice() {
      let itemKey = $('#artifacts').val();
      let type = $('#types').val();
      if (!itemKey || !type) {
        return;
      }

      let item = artifactMap[itemKey];
      let typeGrowth = growthMap[type];
      let artifact_stats = getArtifactStats(typeGrowth.curve[0], item.status[1])

      let level = parseInt($('#levels').val());
      let levels_left = max_level - level;
      let hammers = parseInt($('#hammers').val());
      let hammers_left = item.hnum - hammers;

      let stats_left = Object.assign({}, artifact_stats);
      stats_left.total = 0;

      stats.forEach((stat) => {
        if (!isNaN(artifact_stats[stat.value]) && artifact_stats[stat.value] > item.status[0][stat.value]) {
          let stat_left = artifact_stats[stat.value] - parseInt($('.stat.stat_' + stat.value).val());
          stats_left[stat.value] = stat_left;
          stats_left.total += stat_left;
        }
      });

      if (stats_left.total == 0) {
        $('#details').text('Your item has max stats.');
        return 'Congratulations!';
      } else if (levels_left == 0) {
        let hammers = {
          total: 0
        };
        stats.forEach((stat) => {
          hammers[stat.value] = Math.ceil(stats_left[stat.value] / hammerMap[stat.value]);
          hammers.total += hammers[stat.value];
        });

        if (hammers.total <= hammers_left) {
          $('#details').text('You are out of level ups, but I have calculated that you can use ' + hammers.total + ' hammer(s) to max out the rest of your stats.');
          return 'You can max out your remaining stats using hammers.';
        } else {
          $('#details').text('You are out of level ups. You have ' + hammers_left + ' hammer(s) left, but it seems like you will not max your stats.');
          return 'You did the best you could. You still have ' + hammers_left + ' hammers to use!';
        }
      } else if (stats_left.total <= levels_left) {
        $('#details').text('I have calculated that the total number of stats left (' + stats_left.total + ') is less than the total number of levels left (' + levels_left + '). Since you are guaranteed at least 1 stat to go up per level, you will max out this item just by level up.');
        return 'You\'re on track to max stats! Just level this item up normally until you have max stats.';
      } else {
        let stats_left_after_hammer = Object.assign({}, stats_left);
        let hammers_used = {
          total: 0
        };
        stats.forEach((stat) => {
          if (!isNaN(stats_left_after_hammer[stat.value]) && stats_left_after_hammer[stat.value] > 0) {
            hammers_used[stat.value] = 0;
          }
        });
        while (hammers.total < hammers_left && stats_left_after_hammer.total > levels_left) {
          let best_hammer = {
            amt: 0,
            stat_key:''
          };
          stats.forEach((stat) => {
            if (!isNaN(stats_left_after_hammer[stat.value]) && stats_left_after_hammer[stat.value] > 1) {
              let stat_amt = Math.min(stats_left_after_hammer[stat.value], hammerMap[stat.value]);
              if (stat_amt > best_hammer.amt) {
                best_hammer.amt = stat_amt;
                best_hammer.stat_key = stat.value;
              }
            }
          });

          if (best_hammer.amt != 0) {
            stats_left_after_hammer[best_hammer.stat_key] -= best_hammer.amt;
            stats_left_after_hammer.total -= best_hammer.amt;
            hammers_used[best_hammer.stat_key]++;
            hammers_used.total++;
          }
        }
        let tar_level = level + (levels_left - stats_left_after_hammer.total);
        if (tar_level == level) {
          stats.forEach((stat) => {
            if (!isNaN(stats_left_after_hammer[stat.value]) && stats_left_after_hammer[stat.value] == 0) {
              return 'Use ' + hammers_used[stat.value] + ' ' + stat.label + ' hammer(s) to max out the ' + stat.label + ' stat.';
            }
          });
        } else if (tar_level > level) {
          return 'Level up the item until Level ' + tar_level + '.';
        } else {
          return 'If this messaage shows up, I probably messed up the calculations.';
        }
      }
      //   let hammers_used = {
      //     total: 0
      //   };
      //   let hammer_text;
      //   let stats_left_after_hammer = Object.assign({}, stats_left);
      //
      //   for (let stat of stats) {
      //     if (stats_left_after_hammer.total <= levels_left) {
      //       break;
      //     }
      //
      //     if (!isNaN(artifact_stats[stat.value])
      //         && artifact_stats[stat.value] > item.status[0][stat.value]
      //         && hammerMap[stat.value] > 1) {
      //       if (hammers_used < hammers_left
      //           && stats_left_after_hammer[stat.value] > 0) {
      //         while (hammers_used < hammers_left
      //             && stats_left_after_hammer[stat.value] > 0) {
      //           let remove_stat = hammerMap[stat.value];
      //
      //           if (stats_left_after_hammer[stat.value] < remove_stat) {
      //             remove_stat = stats_left_after_hammer[stat.value];
      //           }
      //
      //           stats_left_after_hammer[stat.value] -= remove_stat;
      //           stats_left_after_hammer.total -= remove_stat;
      //
      //           hammers_used++;
      //         }
      //
      //         if (hammer_text != null) {
      //           hammer_text = 'Use ' + hammers_used + ' ' + stat.label + ' Hammers and update your stats.';
      //         }
      //       }
      //     }
      //   }
      //
      //   if (level <= (max_level - stats_left_after_hammer.total)) {
      //     let tar_level = level;
      //
      //     while (stats_left_after_hammer.total > 0 && tar_level < max_level) {
      //       stats.forEach((stat) => {
      //         if (!isNaN(artifact_stats[stat.value])
      //             && artifact_stats[stat.value] > item.status[0][stat.value]) {
      //           if (item.randa[0][stat.value] > stats_left_after_hammer[stat.value]) {
      //             stats_left_after_hammer.total -= stats_left_after_hammer[stat.value];
      //             stats_left_after_hammer[stat.value] = 0;
      //           } else {
      //             stats_left_after_hammer.total -= item.randa[0][stat.value];
      //             stats_left_after_hammer[stat.value] -= item.randa[0][stat.value];
      //           }
      //         }
      //       });
      //       tar_level++;
      //     }
      //
      //     if (tar_level < max_level) {
      //       return 'Level this item up until level ' + tar_level + ' and update your stats.';
      //     } else {
      //       return 'I have no more advice to give for this item.';
      //     }
      //   }
      // }
    }

    let promiseList = [];

    let typeMap = {};
    promiseList.push(new Promise((resolve, reject) => {
      // init
      $.getJSON('en/ArtifactGrow.json', (data) => {
        let typeNameMap = {};
        data.infos.forEach((info) => {
          typeNameMap[info.key] = info.value;
        });
        // 20200422_4c9ea1e3
        $.getJSON('data/ArtifactRandLot.json', (data) => {
          data.items.forEach((item) => {
            typeMap[item.iname] = [];
            if (item.lot[0].grow1) {
              typeMap[item.iname].push({
                label: typeNameMap[item.lot[0].grow1],
                value: item.lot[0].grow1
              });
            }
            if (item.lot[0].grow2) {
              typeMap[item.iname].push({
                label: typeNameMap[item.lot[0].grow2],
                value: item.lot[0].grow2
              });
            }
            if (item.lot[0].grow3) {
              typeMap[item.iname].push({
                label: typeNameMap[item.lot[0].grow3],
                value: item.lot[0].grow3
              });
            }
          });

          resolve();
        });
      });
    }));

    let growthMap = {};
    promiseList.push(new Promise((resolve, reject) => {
      // init
      $.getJSON('data/Grow.json', (data) => {
        data.items.forEach((item) => {
          growthMap[item.type] = {
            curve: item.curve,
            rstatus : item.rstatus
          }
        });

        resolve();
      });
    }));

    let hammerMap = {};
    promiseList.push(new Promise((resolve, reject) => {
      $.getJSON('data/ArtifactHummer.json', (data) => {
        data.items.forEach((item) => {
          let stat = stats[item.status_up[0].eff_dst];
          hammerMap[stat.value] = item.status_up[0].val;
        });

        resolve();
      });
    }));

    let artifactNameMap = {};
    promiseList.push(new Promise((resolve, reject) => {
      // 20200422_4c9ea1e3 translations
      $.getJSON('en/ArtifactName.json', (data) => {
        data.infos.forEach((info) => {
          artifactNameMap[info.key] = info.value;
        });

        resolve();
      });
    }));

    let artifactCategoryList = [];
    promiseList.push(new Promise((resolve, reject) => {
      $.getJSON('en/ArtifactCategory.json', (data) => {
        artifactCategoryList = data.infos;

        // for some reason doesn't match exactly
        artifactCategoryList.splice(4,1); // remove LARGESWORD
        artifactCategoryList.splice(6,1); // remove ROD
        artifactCategoryList.splice(18,2); // LIGHTSHIELD, HEAVYSHIELD
        artifactCategoryList.splice(22,3); // LIGHTARMOR, HEAVYARMOR, ROBE

        resolve();
      });
    }));

    let artifactMap = {};
    let artifactListByCat = [];
    promiseList.push(new Promise((resolve, reject) => {
      $.getJSON('data/Artifact.json', (data) => {
        data.items.forEach((item) => {
          if (item.type >= 0 && item.rtype != 'AF_LOT_50' && item.rtype != 'AF_LOT_TRUST') {
            artifactMap[item.iname] = item;
            artifactMap[item.iname].name = artifactNameMap[item.iname];

            if (artifactNameMap[item.iname]) {
              let artifactListEntry = {
                label: artifactNameMap[item.iname],
                value : item.iname
              };

              item.cat.forEach((cat) => {
                if (artifactListByCat[cat] == null) {
                  artifactListByCat[cat] = [];
                }

                artifactListByCat[cat].push(artifactListEntry);
              });
            }
          }
        });

        artifactListByCat.forEach((artifactList) => {
          artifactList.sort((a, b) => {
            return a.label > b.label ? 1 : -1;
          });
        });

        resolve();
      });
    }));

    Promise.all(promiseList).then(() => {
      artifactCategoryList.forEach((cat, i) => {
        switch(cat.key) {
          case 'NONE':
          case 'HAMMER':
          case 'INSTRUMENT':
          case 'WHIP':
          case 'THROWING':
          case 'SEPARATOR':
            break;
          default:
            if (artifactListByCat[i]) {
              $('#category').append('<option value="' + i + '">' + cat.value + '</option>');
            }
            break;
        }
      });

      $('#category').focus();
    });
  </script>
</body>
</html>
