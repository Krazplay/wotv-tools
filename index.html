<!DOCTYPE html>
<html>
<head>
<script src="jquery-3.5.0.min.js" type="text/javascript"></script>
<link href="style.css" rel="stylesheet" type="text/css">
</head>
<body>
  <table id="table">
    <tr>
      <th>
        <select id="items" onchange="displayStats()">
          <option disabled selected>-- Select an item --</option>
        </select>
      </th>
      <th>Level</th>
      <th class="stat stat_hp" onclick="toggleSeal('hp')">HP</th>
      <th class="stat stat_mp" onclick="toggleSeal('mp')">TP</th>
      <th class="stat stat_ap" onclick="toggleSeal('ap')">AP</th>
      <th class="stat stat_atk" onclick="toggleSeal('atk')">ATK</th>
      <th class="stat stat_def" onclick="toggleSeal('def')">DEF</th>
      <th class="stat stat_mag" onclick="toggleSeal('mag')">MAG</th>
      <th class="stat stat_mnd" onclick="toggleSeal('mnd')">SPR</th>
      <th class="stat stat_hit" onclick="toggleSeal('hit')">ACC</th>
      <th class="stat stat_dex" onclick="toggleSeal('dex')">DEX</th>
      <th class="stat stat_spd" onclick="toggleSeal('spd')">AGI</th>
      <th class="stat stat_avd" onclick="toggleSeal('avd')">EVA</th>
      <th class="stat stat_crt" onclick="toggleSeal('crt')">CRIT</th>
      <th class="stat stat_crta" onclick="toggleSeal('crta')">CRIT.A</th>
    </tr>
    <tr class="level1"></tr>
    <tr class="level"></tr>
    <tr class="level"></tr>
    <tr class="level"></tr>
    <tr class="level"></tr>
    <tr class="level"></tr>
    <tr class="level"></tr>
    <tr class="level"></tr>
    <tr class="level"></tr>
    <tr class="level"></tr>
    <tr class="level"></tr>
    <tr class="level"></tr>
    <tr class="level"></tr>
    <tr class="level"></tr>
    <tr class="level"></tr>
    <tr class="level"></tr>
    <tr class="level"></tr>
    <tr class="level"></tr>
    <tr class="level"></tr>
    <tr class="level"></tr>
    <tr class="level"></tr>
    <tr class="level"></tr>
    <tr class="level"></tr>
    <tr class="level"></tr>
    <tr class="level"></tr>
    <tr class="level"></tr>
    <tr class="level"></tr>
    <tr class="level"></tr>
    <tr class="level"></tr>
    <tr class="level"></tr>
    <tr class="level"></tr>
    <tr class="level"></tr>
    <tr class="level"></tr>
    <tr class="level"></tr>
    <tr class="level"></tr>
    <tr class="level"></tr>
    <tr class="level"></tr>
    <tr class="level"></tr>
    <tr class="level"></tr>
    <tr class="level"></tr>
    <tr class="level"></tr>
    <tr class="level"></tr>
    <tr class="level"></tr>
    <tr class="level"></tr>
    <tr class="level"></tr>
    <tr class="level"></tr>
    <tr class="level"></tr>
    <tr class="level"></tr>
    <tr class="level"></tr>
  </table>

  <script>
    let stats = [{
      label: "HP",
      value: "hp"
    }, {
      label: "TP",
      value: "mp"
    }, {
      label: "AP",
      value: "ap"
    }, {
      label: "ATK",
      value: "atk"
    }, {
      label: "DEF",
      value: "def"
    }, {
      label: "MAG",
      value: "mag"
    }, {
      label: "SPR",
      value: "mnd"
    }, {
      label: "ACC",
      value: "hit"
    }, {
      label: "DEX",
      value: "dex"
    }, {
      label: "AGI",
      value: "spd"
    }, {
      label: "EVA",
      value: "avd"
    }, {
      label: "CRIT",
      value: "crt"
    }, {
      label: "CRIT.A",
      value: "crta"
    }]
    function displayStats() {
      let itemKey = $('#items').val();

      if (!itemKey) {
        return;
      }

      $('.level1').empty();
      $('.level').empty();

      let item = itemMap[itemKey];
      let types = typeMap[item.rtype];
      let itemStatDist = getItemStatDist(item, types);

      // set first level
      $('.level1').append('<td>' + types.join(' | ') + '</td>');
      stats.forEach((stat) => {
        $('.level1').append('<td>' + item.status[0][stat.value] + '/' + item_stats[stat.value]);
      });

      $('.level').each((el, i) => {
        el.append('<td>' + i + '</td>');

        stats.forEach((stat) => {
          let item_stats = getItemStats(typeGrowth.curve[0], item.status[1]);

          if (!isNaN(item_stats[stat.value])) {
            let ave_stat = item_rates[stat.value] / 100;
            ave_stat *= i * item.randa[0][stat.value];

            ave_stat = Math.min(
              Math.floor(ave_stat + item.status[0][stat.value]),
              item_stats[stat.value]);

            ave_stat +=  '/' + item_stats[stat.value];
          }
          typeStatsRow.append('<td title="' + item_rates[stat.value] + '%">' + ave_stat + '</td>');
        });


      });
    }

    function getItemStatDist(item, types) {
      let itemStatDist = [];

      types.forEach((type, i) => {
        let dist = [];
        let typeGrowth = growthMap[type.value];
        let item_stats = getItemStats(typeGrowth.curve[0], item.status[1]);
        let item_rates = getItemRates(typeGrowth.rstatus[0], item.randr[0]);

        // set lv1
        let next_dist = {};
        stats.forEach((stat) => {
          next_dist[stat.value] = item.status[0][stat.value];
        });

        $('.level').each((el, i) =>
          stats.forEach((stat) => {
            if (!isNaN(item_stats[stat.value])) {
              next_dist[stat.value] += item_rates[stat.value] / 100 * item.randa[0][stat.value];

              if (next_dist[stat.value] > item_stats[stat.value]) {
                next_dist[stat.value] = item_stats[stat.value];
                item_rates[stat.value] = 0;
              }
            }
          });

          dist.push(Object.assign({}, next_dist));
        });

        itemStatDist.push(dist);
      });

      return itemStatDist;
    }

    let seals = {}
    function toggleSeal(stat) {
      if (seals[stat] == 1) {
        delete seals[stat];
        displayStats();
      } else if (Object.keys(seals).length < 3) {
        seals[stat] = 1;
        displayStats();
      }

      $('.stat').removeClass('seal_on');
      Object.keys(seals).forEach((seal) => {
        $('.stat_' + seal).addClass('seal_on');
      })
    }

    function getItemStats(curve, base) {
      let item_stats = {};

      stats.forEach((stat) => {
        if (base[stat.value]) {
          if (curve[stat.value]) {
            item_stats[stat.value] = (100 + curve[stat.value]) / 100 * base[stat.value];

            let isNeg = item_stats[stat.value] < 0;

            item_stats[stat.value] = Math.floor(Math.abs(item_stats[stat.value]));
            if (isNeg) {
              item_stats[stat.value] *= -1;
            }
          } else {
            item_stats[stat.value] = base[stat.value];
          }
        }
      });

      return item_stats;
    }

    function getItemRates(adjust, base) {
      stats.forEach((stat) => {
        if (base[stat.value]) {
          if (adjust[stat.value]) {
            item_rates[stat.value] = base[stat.value] + adjust[stat.value];
          } else {
            item_rates[stat.value] = base[stat.value];
          }

          if (seals[stat.value]) {
            item_rates[stat.value] += sealGrowthMap[stat.value];
          }

          if (item_rates[stat.value] < 0) {
            item_rates[stat.value] = 0;
          }
        }
      });

      return item_rates;
    }

    function getPity(item_rates) {
      let pity_rate = 1;
      let pity_stat;
      let highest_rate = 0;

      stats.forEach((stat) => {
        pity_rate *= (1 - item_rates[stat.value]);
        if (item_rates[stat.value] > highest_rate) {
          pity_stat = stat.value;
        }
      });

      return {
        rate: pity_rate,
        stat: pity_state
      };
    }

    let growthMap = {}, nameMap = {}, sealGrowthMap = {}, typeMap = {};
    let itemMap = {};

    $.getJSON('typenames.json', function(data) {
      let typeNameMap = {};
      data.infos.forEach((info) => {
        typeNameMap[info.key] = info.value;
      });
      $.getJSON('typesets.json', function(data) {
        data.items.forEach((item) => {
          typeMap[item.iname] = [
            {
              label: typeNameMap[item.lot[0].grow1],
              value: item.lot[0].grow1
            }, {
              label: typeNameMap[item.lot[0].grow2],
              value: item.lot[0].grow2
            }, {
              label: typeNameMap[item.lot[0].grow3],
              value: item.lot[0].grow3
            }
          ];
        });
      });
    });

    $.getJSON('growth.json', function(data) {
      data.items.forEach((item) => {
        growthMap[item.type] = {
          curve: item.curve,
          rstatus : item.rstatus
        }
      });
    });

    $.getJSON('names.json', function(data) {
      data.infos.forEach((info) => {
        nameMap[info.key] = info.value;
      });

      $.getJSON('items.json', function(data) {
        let itemList = [];
        data.items.forEach((item) => {
          if (item.type >= 0) {
            itemMap[item.iname] = {
              name: nameMap[item.iname],
              randa: item.randa,
              randr: item.randr,
              rtype: item.rtype,
              status: item.status,
              type: item.type
            };

            itemList.push({
              label: nameMap[item.iname],
              value : item.iname
            });
          }
        });

        itemList.sort((a, b) => {
          return a.label > b.label ? 1 : -1;
        }).forEach((item) => {
          if (item.label) {
            $('#items').append('<option value="' + item.value +'">' + item.label + '</option>');
          }
        });
      });
    });

    $.getJSON('sealGrowth.json', function(data) {
      data.items.forEach((item) => {
        let stat = stats[item.grow_up[0].eff_dst];
        sealGrowthMap[stat.value] = item.grow_up[0].val;
      });
    });
  </script>
</body>
</html>
