<!DOCTYPE html>
<html>
<head>
<script src="jquery-3.5.0.min.js" type="text/javascript"></script>
<link href="style.css" rel="stylesheet" type="text/css">
</head>
<body>
  <h1>
    This tool calculates the AVERAGE stat gain for an item.
  </h1>

  <div id="instructions">
    Select your item, item level, and seal(s).
  </div>

  <div>
    <div id="inputs">
      <select id="items" onchange="onItemChange()">
        <option disabled selected>-- Select an item --</option>
      </select>
      <select id="level" onchange="onItemChange()">
        <option value="10">Lv. 10</option>
        <option value="20">Lv. 20</option>
        <option value="30">Lv. 30</option>
        <option value="40">Lv. 40</option>
        <option value="50" selected>Lv. 50</option>
      </select>
    </div>

    <div id="desc"></div>
    <ul id="skills"></ul>
  </div>

  <table id="table">
    <tr>
      <th>
        Seals <span id="seals_display">0/3</span>
      </th>
      <th class="stat disabled stat_hp" onclick="toggleSeal('hp')">
        <label for="">HP</label><br/>
        <input type="checkbox" disabled />
      </th>
      <th class="stat disabled stat_mp" onclick="toggleSeal('mp')">
        <label for="">TP</label><br/>
        <input type="checkbox" disabled />
      </th>
      <th class="stat disabled stat_ap" onclick="toggleSeal('ap')">
        <label for="">AP</label><br/>
        <input type="checkbox" disabled />
      </th>
      <th class="stat disabled stat_atk" onclick="toggleSeal('atk')">
        <label for="">ATK</label><br/>
        <input type="checkbox" disabled />
      </th>
      <th class="stat disabled stat_def" onclick="toggleSeal('def')">
        <label for="">DEF</label><br/>
        <input type="checkbox" disabled />
      </th>
      <th class="stat disabled stat_mag" onclick="toggleSeal('mag')">
        <label for="">MAG</label><br/>
        <input type="checkbox" disabled />
      </th>
      <th class="stat disabled stat_mnd" onclick="toggleSeal('mnd')">
        <label for="">SPR</label><br/>
        <input type="checkbox" disabled />
      </th>
      <th class="stat disabled stat_hit" onclick="toggleSeal('hit')">
        <label for="">ACC</label><br/>
        <input type="checkbox" disabled />
      </th>
      <th class="stat disabled stat_dex" onclick="toggleSeal('dex')">
        <label for="">DEX</label><br/>
        <input type="checkbox" disabled />
      </th>
      <th class="stat disabled stat_spd" onclick="toggleSeal('spd')">
        <label for="">AGI</label><br/>
        <input type="checkbox" disabled />
      </th>
      <th class="stat disabled stat_avd" onclick="toggleSeal('avd')">
        <label for="">EVA</label><br/>
        <input type="checkbox" disabled />
      </th>
      <th class="stat disabled stat_crt" onclick="toggleSeal('crt')">
        <label for="">CRIT</label><br/>
        <input type="checkbox" disabled />
      </th>
      <th class="stat disabled stat_crta" onclick="toggleSeal('crta')">
        <label for="">CRIT.A</label><br/>
        <input type="checkbox" disabled />
      </th>
    </tr>
    <tr id="grow1_stats"></tr>
    <tr id="grow2_stats"></tr>
    <tr id="grow3_stats"></tr>
  </table>

  <h3>How to craft</h3>
  <div id="all_mat_link"></div>
  <table id="recipe"></table>

  <script>
    let stats = [{
      label: "HP",
      value: "hp"
    }, {
      label: "TP",
      value: "mp"
    }, {
      label: "AP",
      value: "ap"
    }, {
      label: "ATK",
      value: "atk"
    }, {
      label: "DEF",
      value: "def"
    }, {
      label: "MAG",
      value: "mag"
    }, {
      label: "SPR",
      value: "mnd"
    }, {
      label: "ACC",
      value: "hit"
    }, {
      label: "DEX",
      value: "dex"
    }, {
      label: "AGI",
      value: "spd"
    }, {
      label: "EVA",
      value: "avd"
    }, {
      label: "CRIT",
      value: "crt"
    }, {
      label: "CRIT.A",
      value: "crta"
    }];

    function onItemChange() {
      resetSeals();
      displayStats();
    }
    function displayStats() {
      let itemKey = $('#items').val();
      let level = $('#level').val();

      if (!itemKey) {
        return;
      }

      let item = itemMap[itemKey];
      let item_sk = item['skl' + (level/10)];
      let types = typeMap[item.rtype];

      $('#desc').empty();
      switch (item.rare) {
        case 0:
          $('#desc').append('<div>N - Rarity</div>');
          break;
        case 1:
          $('#desc').append('<div>R - Rarity</div>');
          break;
        case 2:
          $('#desc').append('<div>SR - Rarity</div>');
          break;
        case 3:
          $('#desc').append('<div>MR - Rarity</div>');
          break;
        case 4:
          $('#desc').append('<div>UR - Rarity</div>');
          break;
      }
      item.cat.forEach((cat) => {
        $('#desc').append('<div>' + itemCategoryList[cat].value + '</div>');
      });

      $('#skills').empty();
      if (item_sk) {
        item_sk.forEach((skl) => {
          let skill = skillMap[skl];
          if (skill.s_buffs) {
            skill.s_buffs.forEach((s_buff) => {
              let buff = buffMap[s_buff];
              let buff_text;

              switch (buff.type1) {
                case 120:
                  let killer_index_offset = -16;
                  buff_text = buffNameList[buff.type1 + buff.tag1[0]].value;
                  break;
                default:
                buff_text = buffNameList[buff.type1].value;
              }

              switch (buff.calc1) {
                case 3:
                  buff_text += ' Res';
                  break;
              }

              buff_text += ' ' + buff.val1
              $('#skills').append('<div>' + buff_text + '</div>');
            });
          }
        });
      }

      $('#grow1_stats').empty();
      $('#grow2_stats').empty();
      $('#grow3_stats').empty();
      types.forEach((type, i) => {
        let typeGrowth = growthMap[type.value];
        let typeStatsRow = $('#grow' + (i+1) + '_stats');
        let item_stats = getItemStats(typeGrowth.curve[0], item.status[1]);
        let item_rates = getItemRates(typeGrowth.rstatus[0], item.randr[0]);
        let ave_stats = Object.assign({}, item.status[0]);

        for (let i = 1; i < level; i++) {
          let pity_rate = 1;
          let pity_stat;

          stats.forEach((stat) => {
            if (!isNaN(item_stats[stat.value])) {
              ave_stats[stat.value] += item_rates[stat.value] / 100 * item.randa[0][stat.value];
              pity_rate *= (1 - (item_rates[stat.value] / 100));

              if (!pity_stat || item_rates[stat.value] > item_rates[pity_stat]) {
                  pity_stat = stat.value;
              }

              if (ave_stats[stat.value] > item_stats[stat.value]) {
                ave_stats[stat.value] = item_stats[stat.value];
                item_rates[stat.value] = 0;
              }
            }
          });

          // add pity
          ave_stats[pity_stat] += pity_rate;
          if (ave_stats[pity_stat] > item_stats[pity_stat]) {
            ave_stats[pity_stat] = item_stats[pity_stat];
            item_rates[pity_stat] = 0;
          }
        }

        typeStatsRow.append('<td>' + type.label + '</td>');
        stats.forEach((stat) => {
          if (ave_stats[stat.value] > item_stats[stat.value]) {
            ave_stats[stat.value] = item_stats[stat.value];
            item_rates[stat.value] = 0;
          } else {
            ave_stats[stat.value] = Math.round(ave_stats[stat.value]);
          }

          if (!isNaN(item_stats[stat.value] && item.status[0][stat.value] != 0 && item_stats[stat.value] != 0)) {
            $('.stat.stat_' + stat.value).removeClass('disabled');
            typeStatsRow.append('<td>' + ave_stats[stat.value] + '/' + item_stats[stat.value] + '</td>');
          } else {
            typeStatsRow.append('<td></td>');
          }
        });
      });

      // get recipe
      $('#all_mat_link').empty();
      $('#recipe').empty();
      if (recipeMap[item.iname]) {
        let mat_link = 'https://wotvfarmcalculator.github.io/beta.html?i=';
        let all_mats = [];
        recipeMap[item.iname].craft.forEach((material) => {
          switch (material.type) {
            case 0:
              let itemName = itemNameMap[material.id];
              let mat_url = mat_link + encodeURIComponent(itemName);
              all_mats.push(itemName);
              $('#recipe').append('<tr><td>' + material.num + 'x</td><td><a target="_blank" href="' + mat_url + '">' + itemName + '</a></td></tr>');
              break;
            case 1:
              $('#recipe').append('<tr><td>' + material.num + 'x</td><td>' + artifactNameMap[material.id] + ' Lv. ' + material.lv + '</td></tr>');
              break;
          }
        });

        $('#all_mat_link').append('<a target="_blank" href="' + mat_link + all_mats.join(',') +'">All Materials</a>');
      }
    }

    let seals = {}
    function resetSeals() {
      seals = {};
      $('.stat').addClass('disabled');
      $('.stat')
      $('.stat input').prop('checked', false);
    }
    function toggleSeal(stat) {
      if ($('.stat.stat_' + stat).hasClass('disabled')) {
        return;
      }

      if (seals[stat] == 1) {
        $('.stat.stat_' + stat + ' input').prop('checked', false);
        delete seals[stat];
        displayStats();
      } else if (Object.keys(seals).length < 3) {
        seals[stat] = 1;
        $('.stat.stat_' + stat + ' input').prop('checked', true);
        displayStats();
      }

      $('#seals_display').text(Object.keys(seals).length + '/3');
    }

    function getItemStats(curve, base) {
      let item_stats = {};

      stats.forEach((stat) => {
        if (base[stat.value]) {
          if (curve[stat.value]) {
            item_stats[stat.value] = (100 + curve[stat.value]) / 100 * base[stat.value];

            let isNeg = item_stats[stat.value] < 0;

            item_stats[stat.value] = Math.floor(Math.abs(item_stats[stat.value]));
            if (isNeg) {
              item_stats[stat.value] *= -1;
            }
          } else {
            item_stats[stat.value] = base[stat.value];
          }
        }
      });

      return item_stats;
    }

    function getItemRates(adjust, base) {
      let item_rates = {};

      stats.forEach((stat) => {
        if (base[stat.value]) {
          if (adjust[stat.value]) {
            item_rates[stat.value] = base[stat.value] + adjust[stat.value];
          } else {
            item_rates[stat.value] = base[stat.value];
          }

          if (seals[stat.value] && sealGrowthMap[stat.value]) {
            item_rates[stat.value] += sealGrowthMap[stat.value];
          }

          if (item_rates[stat.value] < 0) {
            item_rates[stat.value] = 0;
          }
        }
      });

      return item_rates;
    }

    let typeMap = {};
    $.getJSON('en/ArtifactGrow.json', (data) => {
      let typeNameMap = {};
      data.infos.forEach((info) => {
        typeNameMap[info.key] = info.value;
      });
      $.getJSON('data/ArtifactRandLot.json', (data) => {
        data.items.forEach((item) => {
          typeMap[item.iname] = [];
          if (item.lot[0].grow1) {
            typeMap[item.iname].push({
              label: typeNameMap[item.lot[0].grow1],
              value: item.lot[0].grow1
            });
          }
          if (item.lot[0].grow2) {
            typeMap[item.iname].push({
              label: typeNameMap[item.lot[0].grow2],
              value: item.lot[0].grow2
            });
          }
          if (item.lot[0].grow3) {
            typeMap[item.iname].push({
              label: typeNameMap[item.lot[0].grow3],
              value: item.lot[0].grow3
            });
          }
        });
      });
    });

    let growthMap = {};
    $.getJSON('data/Grow.json', (data) => {
      data.items.forEach((item) => {
        growthMap[item.type] = {
          curve: item.curve,
          rstatus : item.rstatus
        }
      });
    });

    let buffMap = {};
    $.getJSON('data/Buff.json', (data) => {
      data.items.forEach((item) => {
        buffMap[item.iname] = item;
      });
    });

    let buffNameList = [];
    $.getJSON('en/Buff.json', (data) => {
      // pretty sure this is the right list
      // but needs modifications for now
      buffNameList = data.infos;

      // modifications
      // remove first 7
      for (let i = 0; i < 7; i++) {
        buffNameList.splice(0,1);
      }
      // insert 16 dummy
      for (let i = 0; i < 16; i++) {
        buffNameList.splice(5,0,null);
      }
      // insert 12 dummy
      for (let i = 0; i < 11; i++) {
        buffNameList.splice(30,0,null);
      }
      // insert 10 dummy
      for (let i = 0; i < 10; i++) {
        buffNameList.splice(51,0,null);
      }
      // insert 4 dummy
      for (let i = 0; i < 4; i++) {
        buffNameList.splice(66,0,null);
      }
      // insert 10 dummy
      for (let i = 0; i < 10; i++) {
        buffNameList.splice(71,0,null);
      }
      // insert 1 dummy
      for (let i = 0; i < 1; i++) {
        buffNameList.splice(94,0,null);
      }
      // insert 1 dummy
      for (let i = 0; i < 1; i++) {
        buffNameList.splice(118,0,null);
      }
      // insert 10 dummy
      for (let i = 0; i < 10; i++) {
        buffNameList.splice(124,0,null);
      }
      // insert 4 dummy
      for (let i = 0; i < 4; i++) {
        buffNameList.splice(135,0,null);
      }
      // insert 8 dummy
      for (let i = 0; i < 8; i++) {
        buffNameList.splice(143,0,null);
      }
      // insert 10 dummy
      for (let i = 0; i < 10; i++) {
        buffNameList.splice(160,0,null);
      }
      // insert 7 dummy
      for (let i = 0; i < 7; i++) {
        buffNameList.splice(173,0,null);
      }
      // remove 22 Debuff Res
      for (let i = 0; i < 22; i++) {
        buffNameList.splice(183,1);
      }
      // insert 6 dummy
      for (let i = 0; i < 6; i++) {
        buffNameList.splice(184,0,null);
      }
    });

    let skillMap = {};
    $.getJSON('data/Skill.json', (data) => {
      data.items.forEach((item) => {
        skillMap[item.iname] = item;
      });
    });

    let artifactNameMap = {};
    $.getJSON('en/ArtifactName.json', (data) => {
      data.infos.forEach((info) => {
        artifactNameMap[info.key] = info.value;
      });
    });

    let sealGrowthMap = {};
    $.getJSON('data/ArtifactGrowItem.json', (data) => {
      data.items.forEach((item) => {
        let stat = stats[item.grow_up[0].eff_dst];
        sealGrowthMap[stat.value] = item.grow_up[0].val;
      });
    });

    let itemCategoryList = [];
    $.getJSON('en/ArtifactCategory.json', (data) => {
      itemCategoryList = data.infos;

      // for some reason doesn't match exactly
      itemCategoryList.splice(4,1); // remove LARGESWORD
      itemCategoryList.splice(6,1); // remove ROD
      itemCategoryList.splice(18,2); // LIGHTSHIELD, HEAVYSHIELD
      itemCategoryList.splice(22,3); // LIGHTARMOR, HEAVYARMOR, ROBE
    });

    let itemMap = {};
    $.getJSON('data/Artifact.json', (data) => {
      let itemList = [];
      data.items.forEach((item) => {
        if (item.type >= 0 && item.randa && item.randr) {
          itemMap[item.iname] = item;
          itemMap[item.iname].name = artifactNameMap[item.iname];

          itemList.push({
            label: artifactNameMap[item.iname],
            value : item.iname
          });
        }
      });

      itemList.sort((a, b) => {
        return a.label > b.label ? 1 : -1;
      }).forEach((item) => {
        if (item.label) {
          $('#items').append('<option value="' + item.value +'">' + item.label + '</option>');
        }
      });
    });

    // RECIPES
    let recipeMap = {};
    $.getJSON('data/ArtifactRecipe.json', (data) => {
      data.items.forEach((item) => {
        recipeMap[item.iname] = item;
      });
    });

    let itemNameMap = {};
    $.getJSON('en/ItemName.json', (data) => {
      data.infos.forEach((info) => {
        itemNameMap[info.key] = info.value;
      });
    });
  </script>
</body>
</html>
